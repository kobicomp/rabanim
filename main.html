<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>דברי תורה שבועיים - מבואה</title>
    <link rel="icon" href="data:,">
    <style>
        :root {
            --primary-color: #3f51b5;
            --accent-color: #ff9800;
            --bg-color: #f8f9fa;
            --text-color: #333;
            --header-bg: #f0f4f8;
            --footer-bg: #e1e5eb;
            --border-color: #ddd;
        }

        /* ערכות צבעים לקטגוריות שונות */
        body[data-active-category="divrei-torah"] {
            --primary-color: #3f51b5;  /* כחול כהה - ברירת מחדל */
            --accent-color: #ff9800;
        }

        body[data-active-category="aktualya"] {
            --primary-color: #E91E63;  /* ורוד */
            --accent-color: #FF5722;
        }

        body[data-active-category="values"] {
            --primary-color: #4CAF50;  /* ירוק */
            --accent-color: #8BC34A;
        }

        body[data-active-category="language"] {
            --primary-color: #673AB7;  /* סגול */
            --accent-color: #3F51B5;
        }

        body[data-active-category="wisdom"] {
            --primary-color: #2196F3;  /* כחול */
            --accent-color: #03A9F4;
        }

        body[data-active-category="empowerment"] {
            --primary-color: #009688;  /* טורקיז */
            --accent-color: #4DB6AC;
        }

        body[data-active-category="parasha"] {
            --primary-color: #FFC107;  /* צהוב */
            --accent-color: #FFEB3B;
        }

        body[data-active-category="creativity"] {
            --primary-color: #FF5722;  /* כתום-אדום */
            --accent-color: #FF9800;
        }

        body[data-active-category="mission"] {
            --primary-color: #795548;  /* חום */
            --accent-color: #A1887F;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        header {
            background-color: var(--header-bg);
            padding: 1rem 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .site-title {
            font-size: 2.2rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .site-subtitle {
            font-size: 1.2rem;
            text-align: center;
            margin-bottom: 1rem;
            color: #555;
        }

        .hebrew-date {
            text-align: center;
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 0.8rem;
        }

        .parasha-banner {
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            padding: 10px 0;
            font-size: 1.3rem;
            margin-top: 1rem;
        }

        .parasha-selector {
            text-align: center;
            margin: 10px 0;
        }

        .parasha-selector select {
            padding: 8px 15px;
            font-size: 1rem;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            background-color: white;
            cursor: pointer;
            min-width: 200px;
        }

        .category-label {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-right: 8px;
        }

        .content-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 1rem 0;
            justify-content: center;
        }

        .content-card {
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 10px;
            min-width: 200px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .content-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .content-card.active {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(63, 81, 181, 0.3);
        }

        .content-card h4 {
            margin: 0 0 5px 0;
            font-size: 1rem;
            color: var(--primary-color);
        }

        .content-card p {
            margin: 0;
            font-size: 0.8rem;
            color: #666;
        }

        .content-card .year-tag {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
            margin-top: 5px;
        }

        nav {
            display: flex;
            justify-content: center;
            margin-top: 1rem;
            border-top: 1px solid var(--border-color);
            padding-top: 1rem;
        }

        .nav-links {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            list-style: none;
            gap: 20px;
        }

        .nav-links li a {
            display: block;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .nav-links li a:hover,
        .nav-links li a.active {
            background-color: var(--primary-color);
            color: white;
        }

        main {
            padding: 2rem 0;
        }

        .page-title {
            text-align: center;
            margin-bottom: 2rem;
            color: var(--primary-color);
            font-size: 2rem;
        }

        .content-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .content-header {
            border-bottom: 2px solid var(--primary-color);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
        }

        .content-title {
            font-size: 1.6rem;
            color: var(--primary-color);
        }

        .content-meta {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.5rem;
        }

        .year-badge {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-right: 10px;
        }

        .content-body {
            line-height: 1.8;
            font-size: 1.1rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            font-size: 1.2rem;
            color: #777;
        }

        footer {
            background-color: var(--footer-bg);
            padding: 1.5rem 0;
            text-align: center;
            margin-top: 2rem;
            border-top: 1px solid var(--border-color);
        }

        .copyright {
            font-size: 0.9rem;
            color: #555;
        }

        .archive-section {
            margin-top: 3rem;
        }

        .archive-title {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
            text-align: center;
        }

        .archive-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 1.5rem;
        }

        .archive-item {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            transition: transform 0.3s ease;
        }

        .archive-item:hover {
            transform: translateY(-5px);
        }

        .archive-item h4 {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .archive-item p {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .archive-item a {
            display: inline-block;
            margin-top: 0.5rem;
            color: var(--accent-color);
            text-decoration: none;
        }

        .archive-item a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .nav-links {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }

            .content-container {
                padding: 1rem;
            }

            .archive-items {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1 class="site-title">דברי תורה שבועיים</h1>
            <p class="site-subtitle">מאת רבני בית הספר</p>

            <!-- הוספת תצוגת תאריך עברי -->
            <div class="hebrew-date" id="hebrew-date">טוען תאריך עברי...</div>

            <div class="parasha-banner" id="current-parasha-banner">
                פרשת השבוע: <span id="current-parasha-name">טוען...</span>
            </div>

            <div class="parasha-selector">
                <select id="parasha-select" onchange="loadParashaContent(this.value)">
                    <option value="">בחר פרשה...</option>
                    <!-- רשימת הפרשות תיטען באמצעות JavaScript -->
                </select>
            </div>

            <nav>
                <ul class="nav-links">
                    <li><a href="#" class="active" data-category="all">הכל</a></li>
                    <li><a href="#" data-category="divrei-torah">דבר תורה</a></li>
                    <li><a href="#" data-category="aktualya">אקטואליה</a></li>
                    <li><a href="#" data-category="values">ערכים</a></li>
                    <li><a href="#" data-category="language">שפה</a></li>
                    <li><a href="#" data-category="wisdom">פניני חוכמה</a></li>
                    <li><a href="#" data-category="empowerment">העצמה וכלים לחיים</a></li>
                    <li><a href="#" data-category="parasha">אתגר הפרשה</a></li>
                    <li><a href="#" data-category="creativity">יצירה</a></li>
                    <li><a href="#" data-category="mission">שליחות</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container">
        <h2 class="page-title">דבר תורה לפרשת השבוע</h2>

        <div id="content-selector" class="content-selector">
            <!-- כאן יוצגו כרטיסיות של דברי תורה מרובים לפרשה -->
        </div>

        <div id="content-area">
            <div class="loading">טוען את דבר התורה...</div>
        </div>

        <div class="archive-section">
            <h3 class="archive-title">דברי תורה מפרשות קודמות</h3>
            <div id="archive-items" class="archive-items">
                <!-- כאן יוצגו דברי תורה מפרשות קודמות -->
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p class="copyright">© כל הזכויות שמורות לבית הספר - 2025</p>
        </div>
    </footer>

    <script>
        // ========== הגדרות שיש לעדכן ==========
        // קישור לגיליון הנתונים (שנה קישור זה כשצריך)
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSL99eQJihGXzNWteo5ZxrfkMFme2u4_GilpBrq3I1dUhO8iTAz4DhZv_v6I4JgxZ034KTSLuIHAiFD/pub?output=csv';
        // ========================================

        // משתנה גלובלי לשמירת הקטגוריה הפעילה
        let activeCategory = 'all';
        // משתנה גלובלי לשמירת הפרשה הפעילה
        let activeParasha = '';

        // פונקציה לנרמול מקפים (ממיר מקפים מיוחדים למקף רגיל)
        function normalizeHyphens(text) {
            if (!text) return '';
            // החלף את המקף העברי (־) ומקפים מיוחדים אחרים במקף רגיל (-)
            return text.replace(/[\u05BE\u2010-\u2015\u2043\u2212]/g, '-');
        }

        // פונקציה להסרת ניקוד מטקסט עברי
        function removeHebrewNiqqud(text) {
            if (!text) return '';
            return text.replace(/[\u0591-\u05BD\u05BF-\u05C7]/g, '');
        }

        // פונקציה לקביעת פורמט תאריך במבנה YYYY-MM-DD
        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        // פונקציה לחישוב תאריך השבת הקרובה
        function getParashaWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const targetSaturday = new Date(d);
            const daysToAdd = (day === 6) ? 7 : (6 - day);
            targetSaturday.setDate(d.getDate() + daysToAdd);
            return formatDate(targetSaturday);
        }

        // פונקציה להצגת התאריך העברי
        async function displayHebrewDate() {
            try {
                const today = new Date();
                const dateUrl = `https://www.hebcal.com/converter?cfg=json&date=${formatDate(today)}&g2h=1&lg=he`;
                const response = await fetch(dateUrl);
                const data = await response.json();

                if (data && data.hebrew) {
                    // הסר ניקוד מהתאריך העברי
                    const hebrewDateWithoutNiqqud = removeHebrewNiqqud(data.hebrew);
                    document.getElementById('hebrew-date').textContent = hebrewDateWithoutNiqqud;
                } else {
                    document.getElementById('hebrew-date').textContent = 'לא ניתן להציג את התאריך העברי';
                }
            } catch (error) {
                console.error('שגיאה בחישוב התאריך העברי:', error);
                document.getElementById('hebrew-date').textContent = 'לא ניתן להציג את התאריך העברי';
            }
        }

        // טבלת המרה של שמות פרשות מאנגלית לעברית
        const parashaTranslation = {
            'Bereshit': 'בראשית',
            'Noach': 'נח',
            'Lech-Lecha': 'לך לך',
            'Vayera': 'וירא',
            'Chayei Sara': 'חיי שרה',
            'Toldot': 'תולדות',
            'Vayetzei': 'ויצא',
            'Vayishlach': 'וישלח',
            'Vayeshev': 'וישב',
            'Miketz': 'מקץ',
            'Vayigash': 'ויגש',
            'Vayechi': 'ויחי',
            'Shemot': 'שמות',
            'Vaera': 'וארא',
            'Bo': 'בא',
            'Beshalach': 'בשלח',
            'Yitro': 'יתרו',
            'Mishpatim': 'משפטים',
            'Terumah': 'תרומה',
            'Tetzaveh': 'תצוה',
            'Ki Tisa': 'כי תשא',
            'Vayakhel': 'ויקהל',
            'Pekudei': 'פקודי',
            'Vayikra': 'ויקרא',
            'Tzav': 'צו',
            'Shmini': 'שמיני',
            'Tazria': 'תזריע',
            'Metzora': 'מצורע',
            'Achrei Mot': 'אחרי מות',
            'Kedoshim': 'קדושים',
            'Emor': 'אמור',
            'Behar': 'בהר',
            'Bechukotai': 'בחוקותי',
            'Bamidbar': 'במדבר',
            'Nasso': 'נשא',
            'Beha\'alotcha': 'בהעלותך',
            'Sh\'lach': 'שלח',
            'Korach': 'קרח',
            'Chukat': 'חקת',
            'Balak': 'בלק',
            'Pinchas': 'פינחס',
            'Matot': 'מטות',
            'Masei': 'מסעי',
            'Devarim': 'דברים',
            'Vaetchanan': 'ואתחנן',
            'Eikev': 'עקב',
            'Re\'eh': 'ראה',
            'Shoftim': 'שופטים',
            'Ki Teitzei': 'כי תצא',
            'Ki Tavo': 'כי תבוא',
            'Nitzavim': 'ניצבים',
            'Vayeilech': 'וילך',
            'Ha\'Azinu': 'האזינו',
            'Vezot Haberakhah': 'וזאת הברכה',
            // פרשות כפולות
            'Vayakhel-Pekudei': 'ויקהל-פקודי',
            'Tazria-Metzora': 'תזריע-מצורע',
            'Achrei Mot-Kedoshim': 'אחרי מות-קדושים',
            'Behar-Bechukotai': 'בהר-בחוקותי',
            'Chukat-Balak': 'חקת-בלק',
            'Matot-Masei': 'מטות-מסעי',
            'Nitzavim-Vayeilech': 'ניצבים-וילך'
        };

        // מיפוי שמות קטגוריות לשמות תצוגה בעברית
        const categoryLabels = {
            'divrei-torah': 'דבר תורה',
            'aktualya': 'אקטואליה',
            'values': 'ערכים',
            'language': 'שפה',
            'wisdom': 'פניני חוכמה',
            'empowerment': 'העצמה וכלים לחיים',
            'parasha': 'אתגר הפרשה',
            'creativity': 'יצירה',
            'mission': 'שליחות'
        };

        // מיפוי שמות תצוגה בעברית לקטגוריות באנגלית
        const categoryMapping = {
            'דבר תורה': 'divrei-torah',
            'אקטואליה': 'aktualya',
            'ערכים': 'values',
            'שפה': 'language',
            'פניני חוכמה': 'wisdom',
            'העצמה וכלים לחיים': 'empowerment',
            'אתגר הפרשה': 'parasha',
            'יצירה': 'creativity',
            'שליחות': 'mission'
        };

        // פונקציה לקביעת הפרשה הנוכחית לפי התאריך
        async function getCurrentParasha() {
            try {
                const today = new Date();
                const parashaDate = getParashaWeek(today);

                const parashaUrl = `https://www.hebcal.com/leyning?cfg=json&date=${parashaDate}`;
                const response = await fetch(parashaUrl);
                const data = await response.json();

                if (data?.items?.[0]?.name) {
                    // אם יש פרשה, החזר את השם העברי
                    if (data.items[0].name.he) {
                        // הסר ניקוד מהפרשה ונרמל מקפים
                        const parashah = removeHebrewNiqqud(data.items[0].name.he);
                        return normalizeHyphens(parashah);
                    }

                    // אם אין שם עברי, נסה להמיר מאנגלית
                    const englishName = data.items[0].name;
                    if (parashaTranslation[englishName]) {
                        return parashaTranslation[englishName];
                    }

                    // אם לא הצלחנו להמיר, החזר את השם באנגלית
                    return englishName;
                }

                // אם אין פרשה (יום חג למשל), נסה את השבת הבאה
                const nextWeek = new Date(today);
                nextWeek.setDate(today.getDate() + 7);
                const nextParashaDate = getParashaWeek(nextWeek);

                const nextParashaUrl = `https://www.hebcal.com/leyning?cfg=json&date=${nextParashaDate}`;
                const nextResponse = await fetch(nextParashaUrl);
                const nextData = await nextResponse.json();

                if (nextData?.items?.[0]?.name) {
                    if (nextData.items[0].name.he) {
                        const parashah = removeHebrewNiqqud(nextData.items[0].name.he);
                        return normalizeHyphens(parashah);
                    }

                    const nextEnglishName = nextData.items[0].name;
                    if (parashaTranslation[nextEnglishName]) {
                        return parashaTranslation[nextEnglishName];
                    }

                    return nextEnglishName;
                }

                // אם עדיין לא הצלחנו, החזר ברירת מחדל
                return "בראשית";
            } catch (error) {
                console.error('שגיאה בחישוב פרשת השבוע:', error);
                return "בראשית"; // ברירת מחדל במקרה של שגיאה
            }
        }

        // פונקציה לטעינת בחירת הפרשות
        async function loadParashotOptions() {
            const selectElement = document.getElementById('parasha-select');

            // ניקוי אפשרויות קיימות פרט לאפשרות הראשונה
            while (selectElement.options.length > 1) {
                selectElement.remove(1);
            }

            try {
                // קבל את הפרשה הנוכחית
                const currentParasha = await getCurrentParasha();
                activeParasha = currentParasha; // שמור את הפרשה הנוכחית

                // רשימת פרשות קבועה (ללא ניקוד)
                const parashot = [
                    "בראשית", "נח", "לך לך", "וירא", "חיי שרה", "תולדות", "ויצא", "וישלח", "וישב", "מקץ",
                    "ויגש", "ויחי", "שמות", "וארא", "בא", "בשלח", "יתרו", "משפטים", "תרומה", "תצוה",
                    "כי תשא", "ויקהל", "פקודי", "ויקרא", "צו", "שמיני", "תזריע", "מצורע", "אחרי מות", "קדושים",
                    "אמור", "בהר", "בחוקותי", "במדבר", "נשא", "בהעלותך", "שלח", "קרח", "חקת", "בלק",
                    "פינחס", "מטות", "מסעי", "דברים", "ואתחנן", "עקב", "ראה", "שופטים", "כי תצא", "כי תבוא",
                    "ניצבים", "וילך", "האזינו", "וזאת הברכה",
                    // פרשות כפולות
                    "ויקהל-פקודי", "תזריע-מצורע", "אחרי מות-קדושים", "בהר-בחוקותי",
                    "חקת-בלק", "מטות-מסעי", "ניצבים-וילך"
                ];

                // מילוי אפשרויות הבחירה
                parashot.forEach(parasha => {
                    const option = document.createElement('option');
                    option.value = parasha;
                    option.textContent = parasha;

                    // סמן את הפרשה הנוכחית כנבחרת
                    if (normalizeHyphens(parasha) === normalizeHyphens(currentParasha)) {
                        option.selected = true;
                    }

                    selectElement.appendChild(option);
                });

                // עדכון שם הפרשה בכותרת
                document.getElementById('current-parasha-name').textContent = currentParasha;
                document.querySelector('.page-title').textContent = `דבר תורה לפרשת ${currentParasha}`;

                return currentParasha;
            } catch (error) {
                console.error('שגיאה בטעינת הפרשות:', error);
                return "בראשית"; // ברירת מחדל
            }
        }

        // פונקציה לטעינת התוכן מגוגל שיטס - מעודכנת לטיפול בקטגוריות ואינדקסים חדשים
        async function loadParashaContent(parashaName = null, category = null) {
            try {
                // אם נבחרה קטגוריה חדשה, עדכן את הקטגוריה הפעילה
                if (category !== null) {
                    activeCategory = category;

                    // עדכן את ה-UI לפי הקטגוריה הנבחרת
                    document.querySelectorAll('.nav-links a').forEach(link => {
                        link.classList.remove('active');
                    });
                    document.querySelector(`.nav-links a[data-category="${activeCategory}"]`).classList.add('active');

                    // עדכן את ערכת הצבעים באמצעות מאפיין data
                    document.body.setAttribute('data-active-category', activeCategory === 'all' ? '' : activeCategory);
                }

                // קבל את הפרשה הנוכחית אם לא נבחרה פרשה ספציפית
                if (!parashaName) {
                    parashaName = activeParasha || await getCurrentParasha();
                } else {
                    activeParasha = parashaName; // עדכון הפרשה הפעילה
                }

                // נרמל מקפים בשם הפרשה
                parashaName = normalizeHyphens(parashaName);

                // עדכון שם הפרשה בכותרת
                document.getElementById('current-parasha-name').textContent = parashaName;

                // עדכון כותרת העמוד לפי הקטגוריה הנבחרת
                if (activeCategory === 'all') {
                    document.querySelector('.page-title').textContent = `דבר תורה לפרשת ${parashaName}`;
                } else {
                    const categoryLabel = categoryLabels[activeCategory] || activeCategory;
                    document.querySelector('.page-title').textContent = `${categoryLabel} - פרשת ${parashaName}`;
                }

                // טען את הנתונים מהגיליון
                const url = SHEET_URL;
                const response = await fetch(url);
                const csvText = await response.text();
                const rows = parseCSV(csvText);

                console.log("טעינת נתונים מהגיליון, פרשה:", parashaName, "קטגוריה:", activeCategory);

                // רשימת פרשות לחיפוש - בהתחלה רק הפרשה עצמה
                let parashaList = [parashaName];

                // אם זו פרשה כפולה, פצל אותה לפרשות הבודדות
                if (parashaName.includes('-')) {
                    const parts = parashaName.split('-');

                    // הוסף את הפרשות הבודדות
                    parashaList = [...parashaList, parts[0].trim(), parts[1].trim()];
                    console.log(`פרשה כפולה זוהתה: ${parashaName}, מחפש את: ${parashaList.join(', ')}`);
                }

                // מערך שיכיל את כל התוצאות
                let allResults = [];

                // בצע חיפוש לכל פרשה
                for (const searchParasha of parashaList) {
                    console.log(`מחפש תוכן עבור פרשת ${searchParasha}`);

                    // סינון תוצאות עבור פרשה נוכחית וקטגוריה נוכחית
                    // לפי סדר העמודות החדש: A:זמן הגשה (0), B:פרשה (1), C:כותרת (2), D:תוכן לא רלוונטי (3), 
                    // E:תוכן (4), F:שם הכותב (5), G:שנה (6), H:קטגוריה (7), I:זמין (8)
                    const results = rows.filter(row => {
                        if (row.length < 9) return false; // ודא שיש מספיק עמודות (כולל עמודת הזמינות)

                        // ודא שהרשומה זמינה (עמודה I - אינדקס 8)
                        const isAvailable = (
                            row[8]?.trim().toLowerCase() === "כן" ||
                            row[8]?.trim().toLowerCase() === "yes" ||
                            row[8]?.trim() === "1" ||
                            row[8]?.trim().toLowerCase() === "true"
                        );

                        if (!isAvailable) return false;

                        // נרמל מקפים בשם הפרשה מהשורה (עמודה B - אינדקס 1)
                        const normalizedRowParasha = normalizeHyphens(row[1]?.trim() || '');

                        // בדוק התאמה לפרשה הנוכחית
                        const matchesParasha = normalizedRowParasha === searchParasha;

                        if (!matchesParasha) return false;

                        // קבל את הקטגוריה מהשורה (עמודה H - אינדקס 7)
                        const rowCategory = row[7]?.trim() || '';

                        // המר את הקטגוריה העברית למזהה באנגלית אם צריך
                        const categoryKey = categoryMapping[rowCategory] || rowCategory.toLowerCase();

                        // בדוק התאמה לקטגוריה
                        if (activeCategory === 'all') {
                            return true; // כל הקטגוריות מתאימות
                        } else {
                            return categoryKey === activeCategory;
                        }
                    });

                    console.log(`נמצאו ${results.length} תוצאות עבור פרשת ${searchParasha} בקטגוריה ${activeCategory}`);

                    // הוסף את התוצאות למערך הכולל
                    allResults = [...allResults, ...results];
                }

                console.log(`סך הכל נמצאו ${allResults.length} רשומות לפרשת ${parashaName} בקטגוריה ${activeCategory}`);

                // אם יש רשומות, הצג אותן
                if (allResults.length > 0) {
                    // הצג את הראשונה כתוכן ראשי
                    displayContent(allResults[0]);

                    // הצג בוחר תוכן אם יש יותר מרשומה אחת
                    if (allResults.length > 1) {
                        displayContentSelector(allResults, 0); // האינדקס הראשון פעיל כברירת מחדל
                    } else {
                        // אם יש רק רשומה אחת, וודא שבוחר התוכן מוסתר
                        const selectorContainer = document.getElementById('content-selector');
                        if (selectorContainer) {
                            selectorContainer.style.display = 'none';
                        }
                    }
                } else {
                    // אם אין רשומות, הצג הודעה מתאימה
                    let message = '';
                    if (activeCategory !== 'all') {
                        message = `אין כרגע דבר תורה בקטגוריית "${categoryLabels[activeCategory]}" לפרשת ${parashaName}.`;
                    } else {
                        message = `אין כרגע דבר תורה זמין לפרשת ${parashaName}.`;
                    }

                    document.getElementById('content-area').innerHTML = `
                        <div class="content-container">
                            <div class="content-header">
                                <h3 class="content-title">אין תוכן זמין</h3>
                            </div>
                            <div class="content-body">
                                <p>${message}</p>
                            </div>
                        </div>
                    `;

                    // הסתר בוחר התוכן
                    const selectorContainer = document.getElementById('content-selector');
                    if (selectorContainer) {
                        selectorContainer.style.display = 'none';
                    }
                }

                // טעינת ארכיון פרשות קודמות (מפרשות שונות) - רק פריטים זמינים וגם לפי קטגוריה
                // לפי סדר העמודות החדש: A:זמן הגשה (0), B:פרשה (1), C:כותרת (2), D:תוכן לא רלוונטי (3), 
                // E:תוכן (4), F:שם הכותב (5), G:שנה (6), H:קטגוריה (7), I:זמין (8)
                const otherParashot = rows.filter(row => {
                    if (row.length < 9) return false;

                    // ודא שהרשומה זמינה (עמודה I - אינדקס 8)
                    const isAvailable = (
                        row[8]?.trim().toLowerCase() === "כן" ||
                        row[8]?.trim().toLowerCase() === "yes" ||
                        row[8]?.trim() === "1" ||
                        row[8]?.trim().toLowerCase() === "true"
                    );

                    if (!isAvailable) return false;

                    // נרמל מקפים בשם הפרשה מהשורה (עמודה B - אינדקס 1)
                    const normalizedRowParasha = normalizeHyphens(row[1]?.trim() || '');

                    // בדוק שהפרשה לא אחת מהפרשות שאנחנו כבר מציגים
                    const differentParasha = !parashaList.includes(normalizedRowParasha);

                    if (!differentParasha) return false;

                    // קבל את הקטגוריה מהשורה (עמודה H - אינדקס 7)
                    const rowCategory = row[7]?.trim() || '';

                    // המר את הקטגוריה העברית למזהה באנגלית אם צריך
                    const categoryKey = categoryMapping[rowCategory] || rowCategory.toLowerCase();

                    // בדוק התאמה לקטגוריה
                    if (activeCategory === 'all') {
                        return true; // כל הקטגוריות מתאימות
                    } else {
                        return categoryKey === activeCategory;
                    }
                });

                loadArchiveItems(otherParashot);

            } catch (error) {
                document.getElementById('content-area').innerHTML = `
                    <div class="content-container">
                        <div class="content-header">
                            <h3 class="content-title">שגיאה בטעינת התוכן</h3>
                        </div>
                        <div class="content-body">
                            <p>לא ניתן לטעון את התוכן כרגע. אנא נסה שוב מאוחר יותר.</p>
                            <p>פרטי השגיאה: ${error.message}</p>
                        </div>
                    </div>
                `;
                console.error('Error loading content:', error);
            }
        }

        // פונקציה להצגת בוחר התוכן כשיש מספר דברי תורה לאותה פרשה
        function displayContentSelector(entries, activeIndex) {
            const selectorContainer = document.getElementById('content-selector');
            selectorContainer.innerHTML = '';
            selectorContainer.style.display = 'flex';

            entries.forEach((entry, index) => {
                // לפי סדר העמודות החדש: A:זמן הגשה (0), B:פרשה (1), C:כותרת (2), D:תוכן לא רלוונטי (3), 
                // E:תוכן (4), F:שם הכותב (5), G:שנה (6), H:קטגוריה (7), I:זמין (8)
                const [timestamp, parasha, title, contentNotUsed, content, author, year, category, isAvailable] = entry;

                const card = document.createElement('div');
                card.className = `content-card ${index === activeIndex ? 'active' : ''}`;

                // בניית תוכן הכרטיסיה כולל תווית הקטגוריה
                let cardContent = `<h4>${title}</h4>`;

                // הוסף תווית קטגוריה אם קיימת
                if (category) {
                    const categoryKey = categoryMapping[category] || category.toLowerCase();
                    const displayCategory = category;
                    cardContent += `<span class="category-label">${displayCategory}</span>`;
                }

                cardContent += `<p>מאת: ${author}</p>`;

                // הוסף תווית שנה אם קיימת
                if (year) {
                    cardContent += `<span class="year-tag">${year}</span>`;
                }

                card.innerHTML = cardContent;

                card.addEventListener('click', function() {
                    // הסר את המחלקה 'active' מכל הכרטיסיות
                    document.querySelectorAll('.content-card').forEach(c => c.classList.remove('active'));
                    // הוסף את המחלקה 'active' לכרטיסיה הנוכחית
                    this.classList.add('active');
                    // הצג את התוכן המתאים
                    displayContent(entries[index]);
                });

                selectorContainer.appendChild(card);
            });
        }

        // פונקציה משופרת לפרסור CSV שמטפלת טוב יותר בשורות עם תוכן מרובה שורות
        function parseCSV(text) {
            const rows = [];
            const lines = text.split('\n');
            
            console.log("מספר שורות בקובץ CSV:", lines.length);
            
            // נדלג על שורת הכותרות
            let currentRow = [];
            let currentValue = '';
            let inQuotes = false;
            
            // עיבוד כל השורות
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                
                // דלג על שורות ריקות
                if (!inQuotes && line.trim() === '') continue;
                
                // עיבוד כל תו בשורה
                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    
                    if (char === '"') {
                        // טיפול במרכאות - החלף את מצב המרכאות
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        // סיום תא - הוסף את הערך הנוכחי לשורה
                        currentRow.push(currentValue);
                        currentValue = '';
                    } else {
                        // הוסף את התו לערך הנוכחי
                        currentValue += char;
                    }
                }
                
                // אם אנחנו לא בתוך מרכאות, זה סוף השורה
                if (!inQuotes) {
                    // הוסף את התא האחרון
                    currentRow.push(currentValue);
                    // הוסף את השורה למערך התוצאות
                    rows.push(currentRow);
                    // איפוס למעבר לשורה הבאה
                    currentRow = [];
                    currentValue = '';
                } else {
                    // אם אנחנו בתוך מרכאות, הוסף שורה חדשה לערך הנוכחי
                    currentValue += '\n';
                }
            }
            
            // אם יש שורה אחרונה שלא הסתיימה
            if (currentRow.length > 0 || currentValue.length > 0) {
                currentRow.push(currentValue);
                rows.push(currentRow);
            }
            
            return rows;
        }

        // הצגת התוכן הראשי בעמוד - מעודכן להצגת קטגוריה ואינדקסים חדשים
        function displayContent(contentRow) {
            // לפי סדר העמודות החדש: A:זמן הגשה (0), B:פרשה (1), C:כותרת (2), D:תוכן לא רלוונטי (3), 
            // E:תוכן (4), F:שם הכותב (5), G:שנה (6), H:קטגוריה (7), I:זמין (8)
            const [timestamp, parasha, title, contentNotUsed, content, author, year, category, isAvailable] = contentRow;

            // הכנת תצוגת הקטגוריה
            let categoryHtml = '';
            if (category) {
                const categoryKey = categoryMapping[category] || category.toLowerCase();
                categoryHtml = `<span class="category-label">${category}</span>`;
            }

            // פורמט לתאריך הגשה
            let timestampFormatted = '';
            if (timestamp) {
                try {
                    const date = new Date(timestamp);
                    if (!isNaN(date.getTime())) {
                        timestampFormatted = date.toLocaleDateString('he-IL');
                    } else {
                        timestampFormatted = timestamp;
                    }
                } catch (e) {
                    timestampFormatted = timestamp;
                }
            }

            const contentHtml = `
                <div class="content-container">
                    <div class="content-header">
                        <h3 class="content-title">
                            ${year ? `<span class="year-badge">${year}</span>` : ''}
                            ${title}
                        </h3>
                        <div class="content-meta">
                            ${categoryHtml}
                            <span>מאת: ${author}</span>
                            ${timestamp ? `<span> | נכתב בתאריך: ${timestampFormatted}</span>` : ''}
                        </div>
                    </div>
                    <div class="content-body">
                        ${content}
                    </div>
                </div>
            `;

            document.getElementById('content-area').innerHTML = contentHtml;
        }

        // טעינת ארכיון פרשות קודמות - מעודכן לסדר העמודות החדש
        function loadArchiveItems(rows) {
            const archiveContainer = document.getElementById('archive-items');
            archiveContainer.innerHTML = '';

            // מיון השורות לפי תאריך הגשה (מהחדש לישן)
            rows.sort((a, b) => {
                if (a.length < 1 || b.length < 1) return 0;
                const dateA = new Date(a[0]);
                const dateB = new Date(b[0]);
                return dateB - dateA;
            });

            // מספר מוגבל של פריטים להצגה בארכיון
            const maxItems = 6;
            let count = 0;

            for (const row of rows) {
                // ודא שיש מספיק עמודות בשורה
                if (row.length < 9) continue;

                // לפי סדר העמודות החדש: A:זמן הגשה (0), B:פרשה (1), C:כותרת (2), D:תוכן לא רלוונטי (3), 
                // E:תוכן (4), F:שם הכותב (5), G:שנה (6), H:קטגוריה (7), I:זמין (8)
                const [timestamp, parasha, title, contentNotUsed, content, author, year, category, isAvailable] = row;

                // דלג על שורות לא תקינות
                if (!parasha || !title) continue;

                // הגבלת מספר הפריטים
                if (count >= maxItems) break;

                // הכנת תצוגת הקטגוריה
                let categoryHtml = '';
                if (category) {
                    const displayCategory = category;
                    categoryHtml = `<span class="category-label">${displayCategory}</span>`;
                }

                const archiveItem = document.createElement('div');
                archiveItem.className = 'archive-item';
                archiveItem.innerHTML = `
                    <h4>${title}</h4>
                    <p>פרשת ${parasha} ${year ? `(${year})` : ''}</p>
                    <p>${categoryHtml} מאת: ${author}</p>
                    <a href="#" onclick="selectParashaAndCategory('${parasha}', '${categoryMapping[category] || category?.toLowerCase() || 'all'}'); return false;">לקריאה</a>
                `;

                archiveContainer.appendChild(archiveItem);
                count++;
            }

            if (count === 0) {
                let message = '';
                if (activeCategory !== 'all') {
                    message = `אין דברי תורה קודמים בקטגוריית ${categoryLabels[activeCategory]} בארכיון.`;
                } else {
                    message = 'אין דברי תורה קודמים בארכיון.';
                }

                archiveContainer.innerHTML = `<p style="text-align: center; grid-column: 1/-1;">${message}</p>`;
            }
        }

        // פונקציה לבחירת פרשה וקטגוריה בבת אחת
        function selectParashaAndCategory(parasha, category) {
            // עדכן את הפרשה הנבחרת בתיבת הבחירה
            const selectElement = document.getElementById('parasha-select');
            for (let i = 0; i < selectElement.options.length; i++) {
                if (selectElement.options[i].value === parasha) {
                    selectElement.selectedIndex = i;
                    break;
                }
            }

            // טען את התוכן לפי הפרשה והקטגוריה שנבחרו
            loadParashaContent(parasha, category);
        }

        // הוסף ניהול אירועי קטגוריה
        function setupCategoryHandlers() {
            document.querySelectorAll('.nav-links a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const category = this.getAttribute('data-category');

                    // טען תוכן חדש לפי הקטגוריה הנבחרת
                    loadParashaContent(activeParasha, category);
                });
            });
        }

        // אתחול הדף כשהוא נטען
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                // הצג תאריך עברי
                await displayHebrewDate();

                // טען את רשימת הפרשות עם הפרשה הנוכחית מסומנת
                const currentParasha = await loadParashotOptions();

                // הגדר מטפלי אירועים לקטגוריות
                setupCategoryHandlers();

                // טען את התוכן של הפרשה הנוכחית
                await loadParashaContent(currentParasha, 'all');
            } catch (error) {
                console.error('שגיאה באתחול הדף:', error);
                // טען גרסה פשוטה במקרה של שגיאה
                document.querySelector('.page-title').textContent = 'דבר תורה לפרשת השבוע';
                document.getElementById('current-parasha-name').textContent = 'בראשית';
                loadParashaContent('בראשית', 'all');
            }
        });
    </script>
</body>
</html>
