<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>דברי תורה שבועיים - סגל רבני החמ"ד</title>
    <link rel="icon" href="data:,">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3f51b5;
            --accent-color: #ff9800;
            --bg-color: #f8f9fa;
            --text-color: #333;
            --header-bg: #f0f4f8;
            --footer-bg: #e1e5eb;
            --border-color: #ddd;
            --gradient-start: #4062bb;
            --gradient-end: #5a7ed2;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --card-bg: #ffffff;
            --header-height: auto;
            --border-radius: 10px;
            --transition-speed: 0.3s;
        }

        /* ערכות צבעים לקטגוריות שונות */
        body[data-active-category="divrei-torah"] {
            --primary-color: #4062bb;  /* כחול כהה - ברירת מחדל */
            --accent-color: #ff9800;
            --gradient-start: #4062bb;
            --gradient-end: #5a7ed2;
        }

        body[data-active-category="aktualya"] {
            --primary-color: #E91E63;  /* ורוד */
            --accent-color: #FF5722;
            --gradient-start: #E91E63;
            --gradient-end: #F06292;
        }

        body[data-active-category="values"] {
            --primary-color: #4CAF50;  /* ירוק */
            --accent-color: #8BC34A;
            --gradient-start: #4CAF50;
            --gradient-end: #81C784;
        }

        body[data-active-category="language"] {
            --primary-color: #673AB7;  /* סגול */
            --accent-color: #3F51B5;
            --gradient-start: #673AB7;
            --gradient-end: #9575CD;
        }

        body[data-active-category="wisdom"] {
            --primary-color: #2196F3;  /* כחול */
            --accent-color: #03A9F4;
            --gradient-start: #2196F3;
            --gradient-end: #64B5F6;
        }

        body[data-active-category="empowerment"] {
            --primary-color: #009688;  /* טורקיז */
            --accent-color: #4DB6AC;
            --gradient-start: #009688;
            --gradient-end: #4DB6AC;
        }

        body[data-active-category="parasha"] {
            --primary-color: #FFC107;  /* צהוב */
            --accent-color: #FFEB3B;
            --gradient-start: #FFC107;
            --gradient-end: #FFECB3;
        }

        body[data-active-category="creativity"] {
            --primary-color: #FF5722;  /* כתום-אדום */
            --accent-color: #FF9800;
            --gradient-start: #FF5722;
            --gradient-end: #FF8A65;
        }

        body[data-active-category="mission"] {
            --primary-color: #795548;  /* חום */
            --accent-color: #A1887F;
            --gradient-start: #795548;
            --gradient-end: #A1887F;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Rubik', 'Heebo', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            background-image: linear-gradient(135deg, rgba(240, 244, 248, 0.8) 0%, rgba(248, 250, 252, 0.8) 100%);
            background-attachment: fixed;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        header {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
            padding: 0.8rem 0;
            box-shadow: 0 2px 15px var(--shadow-color);
            position: sticky;
            top: 0;
            z-index: 100;
            transition: all var(--transition-speed) ease;
        }

        .site-title {
            font-size: 1.8rem;
            color: white;
            margin: 0.2rem 0;
            text-align: center;
            font-weight: 700;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
        }

        .site-subtitle {
            font-size: 1rem;
            text-align: center;
            margin-bottom: 0.5rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 400;
        }

        .header-flex {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            flex: 1;
            min-width: 250px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .hebrew-date {
            display: inline-block;
            background-color: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            color: white;
            margin: 0.3rem 0;
        }

        .parasha-banner {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            text-align: center;
            padding: 7px 15px;
            font-size: 1rem;
            margin: 0.3rem 0;
            border-radius: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: inline-block;
        }

        .parasha-selector {
            margin: 0 0.5rem;
        }

        .parasha-selector select {
            padding: 7px 12px;
            font-size: 0.9rem;
            border-radius: 20px;
            border: none;
            background-color: white;
            cursor: pointer;
            min-width: 150px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            color: var(--primary-color);
        }

        .category-label {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            margin-right: 8px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .content-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin: 1rem 0;
            justify-content: center;
        }

        .content-card {
            background-color: var(--card-bg);
            border: none;
            border-radius: var(--border-radius);
            padding: 12px;
            min-width: 200px;
            max-width: 300px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            box-shadow: 0 3px 8px var(--shadow-color);
        }

        .content-card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            transform: translateY(-3px);
        }

        .content-card.active {
            border-right: 4px solid var(--primary-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .content-card h4 {
            margin: 0 0 8px 0;
            font-size: 1.1rem;
            color: var(--primary-color);
            border-bottom: 2px solid rgba(0, 0, 0, 0.05);
            padding-bottom: 5px;
        }

        .content-card p {
            margin: 0;
            font-size: 0.85rem;
            color: #666;
        }

        .content-card .year-tag {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-top: 8px;
        }

        nav {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 0.5rem 0;
            margin-top: 0.5rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
        }

        nav::-webkit-scrollbar { 
            display: none; /* Chrome, Safari, Edge */
        }

        .nav-links {
            display: flex;
            justify-content: center;
            list-style: none;
            gap: 8px;
            flex-wrap: nowrap;
            padding: 0 10px;
        }

        .nav-links li a {
            display: block;
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 5px 10px;
            border-radius: 18px;
            transition: all var(--transition-speed) ease;
            white-space: nowrap;
            font-size: 0.85rem;
        }

        .nav-links li a:hover,
        .nav-links li a.active {
            background-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        main {
            padding: 1.5rem 0;
            margin-top: 1rem;
        }

        .page-title {
            text-align: center;
            margin-bottom: 1.5rem;
            color: var(--primary-color);
            font-size: 1.8rem;
            position: relative;
            padding-bottom: 10px;
        }

        .page-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background-color: var(--primary-color);
            border-radius: 3px;
        }

        .content-container {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px var(--shadow-color);
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-top: 5px solid var(--primary-color);
        }

        .content-header {
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
            padding-bottom: 0.8rem;
        }

        .content-title {
            font-size: 1.6rem;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .content-meta {
            font-size: 0.9rem;
            color: #777;
            margin-top: 0.8rem;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .year-badge {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 2px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            margin-right: 10px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .content-body {
            line-height: 1.8;
            font-size: 1.1rem;
        }

        /* בסיס לפסקאות באתר */
        .content-body p {
            margin-bottom: 1rem;
        }

        /* תמיכה בכיוון טקסט RTL */
        .content-body .ql-direction-rtl,
        .content-body [dir="rtl"] {
            direction: rtl !important;
            text-align: right;
        }

        .loading {
            text-align: center;
            padding: 2.5rem;
            font-size: 1.2rem;
            color: #777;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px var(--shadow-color);
        }

        .loading:after {
            content: "...";
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: "."; }
            40% { content: ".."; }
            60%, 100% { content: "..."; }
        }

        .archive-section {
            margin-top: 3rem;
        }

        .archive-title {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            text-align: center;
            position: relative;
            padding-bottom: 10px;
        }

        .archive-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 3px;
            background-color: var(--primary-color);
            border-radius: 3px;
        }

        .archive-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 1.5rem;
        }

        .archive-item {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 3px 10px var(--shadow-color);
            padding: 1.2rem;
            transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
            border-bottom: 3px solid var(--primary-color);
        }

        .archive-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .archive-item h4 {
            color: var(--primary-color);
            margin-bottom: 0.8rem;
            font-size: 1.1rem;
        }

        .archive-item p {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .archive-item a {
            display: inline-block;
            margin-top: 0.8rem;
            color: var(--primary-color);
            text-decoration: none;
            padding: 5px 12px;
            border: 1px solid var(--primary-color);
            border-radius: 20px;
            font-size: 0.85rem;
            transition: all var(--transition-speed) ease;
        }

        .archive-item a:hover {
            background-color: var(--primary-color);
            color: white;
        }
/* ===== סגנונות חדשים לתמיכה בתוכן עשיר ===== */

/* צבעי טקסט */
.content-body [style*="color: rgb("],
.content-body [style*="color:rgb("],
.content-body [style*="color: #"],
.content-body [style*="color:#"],
.content-body span[style*="color:"],
.content-body span[style*="color: "] {
    color: inherit !important; /* שמירה על הצבע המקורי מה-style */
}

/* צבעי רקע */
.content-body [style*="background-color: rgb("],
.content-body [style*="background-color:rgb("],
.content-body [style*="background-color: #"],
.content-body [style*="background-color:#"],
.content-body span[style*="background-color:"],
.content-body span[style*="background-color: "] {
    background-color: inherit !important; /* שמירה על הצבע המקורי מה-style */
}

/* צבעים ספציפיים */
/* אדום */
.content-body [style*="color: red"],
.content-body [style*="color:red"],
.content-body span[style*="color: rgb(255, 0, 0)"],
.content-body span[style*="color: rgb(230, 0, 0)"],
.content-body span[style*="color: #ff0000"],
.content-body span.ql-color-red,
.content-body span.color-red {
    color: #ff0000 !important;
}

/* כחול */
.content-body [style*="color: blue"],
.content-body [style*="color:blue"],
.content-body span[style*="color: rgb(0, 0, 255)"],
.content-body span[style*="color: rgb(0, 102, 204)"],
.content-body span[style*="color: #0000ff"],
.content-body span[style*="color: #0066cc"],
.content-body span.ql-color-blue,
.content-body span.color-blue {
    color: #0066cc !important;
}

/* ירוק */
.content-body [style*="color: green"],
.content-body [style*="color:green"],
.content-body span[style*="color: rgb(0, 128, 0)"],
.content-body span[style*="color: rgb(0, 138, 0)"],
.content-body span[style*="color: #008000"],
.content-body span.ql-color-green,
.content-body span.color-green {
    color: #008000 !important;
}

/* סגול */
.content-body [style*="color: purple"],
.content-body [style*="color:purple"],
.content-body span[style*="color: rgb(128, 0, 128)"],
.content-body span[style*="color: rgb(153, 51, 255)"],
.content-body span[style*="color: #800080"],
.content-body span[style*="color: #9933ff"],
.content-body span.ql-color-purple,
.content-body span.color-purple,
.content-body span.color-purple-light {
    color: #800080 !important;
}

/* כתום */
.content-body [style*="color: orange"],
.content-body [style*="color:orange"],
.content-body span[style*="color: rgb(255, 165, 0)"],
.content-body span[style*="color: rgb(255, 102, 0)"],
.content-body span[style*="color: #ffa500"],
.content-body span[style*="color: #ff6600"],
.content-body span.ql-color-orange,
.content-body span.color-orange {
    color: #ff6600 !important;
}

/* צהוב */
.content-body [style*="color: yellow"],
.content-body [style*="color:yellow"],
.content-body span[style*="color: rgb(255, 255, 0)"],
.content-body span[style*="color: #ffff00"],
.content-body span.ql-color-yellow {
    color: #806600 !important; /* צהוב כהה יותר לקריאות */
}

/* רקע צהוב */
.content-body [style*="background-color: yellow"],
.content-body [style*="background-color:yellow"],
.content-body span[style*="background-color: rgb(255, 255, 0)"],
.content-body span[style*="background-color: #ffff00"],
.content-body span.ql-background-yellow,
.content-body span.bg-yellow {
    background-color: #ffff00 !important;
}

/* רקע כחול בהיר */
.content-body [style*="background-color: lightblue"],
.content-body [style*="background-color:lightblue"],
.content-body span[style*="background-color: rgb(173, 216, 230)"],
.content-body span[style*="background-color: #add8e6"],
.content-body span.bg-lightblue {
    background-color: #add8e6 !important;
}

/* רקע ירוק בהיר */
.content-body [style*="background-color: lightgreen"],
.content-body [style*="background-color:lightgreen"],
.content-body span[style*="background-color: rgb(144, 238, 144)"],
.content-body span[style*="background-color: #90ee90"],
.content-body span.bg-lightgreen {
    background-color: #90ee90 !important;
}

/* רקע ורוד */
.content-body [style*="background-color: pink"],
.content-body [style*="background-color:pink"],
.content-body span[style*="background-color: rgb(255, 192, 203)"],
.content-body span[style*="background-color: #ffc0cb"],
.content-body span.bg-pink {
    background-color: #ffc0cb !important;
}

/* רקע כחול כהה */
.content-body span[style*="background-color: rgb(0, 102, 204)"],
.content-body span[style*="background-color: #0066cc"],
.content-body span.bg-blue-dark {
    background-color: #0066cc !important;
    color: white !important; /* להבטיח קריאות */
}

/* סגנונות מיוחדים לתוכן מהטופס המשודרג */
.content-body .rich-text-content .color-blue,
.content-body .color-forced .color-blue { 
    color: #0066cc !important; 
}

.content-body .rich-text-content .color-red,
.content-body .color-forced .color-red { 
    color: #ff0000 !important; 
}

.content-body .rich-text-content .color-green,
.content-body .color-forced .color-green { 
    color: #008000 !important; 
}

.content-body .rich-text-content .color-purple,
.content-body .color-forced .color-purple { 
    color: #800080 !important; 
}

.content-body .rich-text-content .color-purple-light,
.content-body .color-forced .color-purple-light { 
    color: #9933ff !important; 
}

.content-body .rich-text-content .color-orange,
.content-body .color-forced .color-orange { 
    color: #ff6600 !important; 
}

.content-body .rich-text-content .bg-yellow,
.content-body .color-forced .bg-yellow { 
    background-color: #ffff00 !important; 
}

.content-body .rich-text-content .bg-lightblue,
.content-body .color-forced .bg-lightblue { 
    background-color: #add8e6 !important; 
}

.content-body .rich-text-content .bg-lightgreen,
.content-body .color-forced .bg-lightgreen { 
    background-color: #90ee90 !important; 
}

.content-body .rich-text-content .bg-pink,
.content-body .color-forced .bg-pink { 
    background-color: #ffc0cb !important; 
}

.content-body .rich-text-content .bg-blue-dark,
.content-body .color-forced .bg-blue-dark { 
    background-color: #0066cc !important;
    color: white !important;
}
        /* ===== סגנונות חדשים לתמיכה בתוכן עשיר ===== */

        /* תמיכה בצבעים שמגיעים מהטופס - חשוב: תגים עם צבע ישירים */
        .content-body [style*="color: red"],
        .content-body [style*="color:red"],
        .content-body span[style*="color: rgb(230, 0, 0)"],
        .content-body span[style*="color: rgb(255, 0, 0)"],
        .content-body span.ql-color-red,
        .content-body span.color-red {
            color: red !important;
        }

        .content-body [style*="color: blue"],
        .content-body [style*="color:blue"],
        .content-body span[style*="color: rgb(0, 0, 255)"],
        .content-body span[style*="color: rgb(0, 102, 204)"],
        .content-body span.ql-color-blue,
        .content-body span.color-blue {
            color: blue !important;
        }

        .content-body [style*="color: green"],
        .content-body [style*="color:green"],
        .content-body span[style*="color: rgb(0, 128, 0)"],
        .content-body span.ql-color-green,
        .content-body span.color-green {
            color: green !important;
        }

        .content-body [style*="color: purple"],
        .content-body [style*="color:purple"],
        .content-body span[style*="color: rgb(128, 0, 128)"],
        .content-body span[style*="color: rgb(153, 51, 255)"],
        .content-body span.ql-color-purple,
        .content-body span.color-purple,
        .content-body span.color-purple-light {
            color: purple !important;
        }

        .content-body [style*="color: orange"],
        .content-body [style*="color:orange"],
        .content-body span[style*="color: rgb(255, 165, 0)"],
        .content-body span[style*="color: rgb(255, 102, 0)"],
        .content-body span.ql-color-orange,
        .content-body span.color-orange {
            color: orange !important;
        }

        .content-body [style*="color: yellow"],
        .content-body [style*="color:yellow"],
        .content-body span[style*="color: rgb(255, 255, 0)"],
        .content-body span.ql-color-yellow {
            color: #806600 !important; /* צהוב כהה יותר לקריאות */
        }

        /* צבעי רקע */
        .content-body [style*="background-color: yellow"],
        .content-body [style*="background-color:yellow"],
        .content-body span[style*="background-color: rgb(255, 255, 0)"],
        .content-body span.ql-background-yellow,
        .content-body span.bg-yellow {
            background-color: yellow !important;
        }

        .content-body [style*="background-color: lightblue"],
        .content-body [style*="background-color:lightblue"],
        .content-body span[style*="background-color: rgb(173, 216, 230)"],
        .content-body span.bg-lightblue {
            background-color: lightblue !important;
        }

        .content-body [style*="background-color: lightgreen"],
        .content-body [style*="background-color:lightgreen"],
        .content-body span[style*="background-color: rgb(144, 238, 144)"],
        .content-body span.bg-lightgreen {
            background-color: lightgreen !important;
        }

        .content-body [style*="background-color: pink"],
        .content-body [style*="background-color:pink"],
        .content-body span[style*="background-color: rgb(255, 192, 203)"],
        .content-body span.bg-pink {
            background-color: pink !important;
        }

        /* צבעים נוספים שזיהינו בתוכן */
        .content-body span[style*="background-color: rgb(0, 102, 204)"],
        .content-body span.bg-blue-dark {
            background-color: #0066cc !important;
        }

        /* יישורי טקסט מיוחדים */
        .content-body p[style*="text-align: center"],
        .content-body p[align="center"],
        .content-body p.ql-align-center,
        .content-body h1[style*="text-align: center"],
        .content-body h2[style*="text-align: center"],
        .content-body h3[style*="text-align: center"],
        .content-body h4[style*="text-align: center"],
        .content-body h5[style*="text-align: center"],
        .content-body h6[style*="text-align: center"],
        .content-body blockquote[style*="text-align: center"],
        .content-body blockquote.ql-align-center {
            text-align: center !important;
            display: block !important;
        }

        .content-body p[style*="text-align: right"],
        .content-body p[align="right"],
        .content-body p.ql-align-right,
        .content-body h1[style*="text-align: right"],
        .content-body h2[style*="text-align: right"],
        .content-body h3[style*="text-align: right"],
        .content-body h4[style*="text-align: right"],
        .content-body h5[style*="text-align: right"],
        .content-body h6[style*="text-align: right"],
        .content-body blockquote[style*="text-align: right"],
        .content-body blockquote.ql-align-right {
            text-align: right !important;
            display: block !important;
        }

        .content-body p[style*="text-align: left"],
        .content-body p[align="left"],
        .content-body p.ql-align-left,
        .content-body h1[style*="text-align: left"],
        .content-body h2[style*="text-align: left"],
        .content-body h3[style*="text-align: left"],
        .content-body h4[style*="text-align: left"],
        .content-body h5[style*="text-align: left"],
        .content-body h6[style*="text-align: left"],
        .content-body blockquote[style*="text-align: left"],
        .content-body blockquote.ql-align-left {
            text-align: left !important;
            display: block !important;
        }

        .content-body p[style*="text-align: justify"],
        .content-body p[align="justify"],
        .content-body p.ql-align-justify,
        .content-body h1[style*="text-align: justify"],
        .content-body h2[style*="text-align: justify"],
        .content-body h3[style*="text-align: justify"],
        .content-body h4[style*="text-align: justify"],
        .content-body h5[style*="text-align: justify"],
        .content-body h6[style*="text-align: justify"],
        .content-body blockquote[style*="text-align: justify"],
        .content-body blockquote.ql-align-justify {
            text-align: justify !important;
            display: block !important;
        }

        /* אפשרות גם ליישור תוכן בתוך div */
        .content-body div[style*="text-align: center"],
        .content-body div[align="center"] {
            text-align: center !important;
            display: block !important;
        }

        .content-body div[style*="text-align: right"],
        .content-body div[align="right"] {
            text-align: right !important;
            display: block !important;
        }

        .content-body div[style*="text-align: left"],
        .content-body div[align="left"] {
            text-align: left !important;
            display: block !important;
        }

        .content-body div[style*="text-align: justify"],
        .content-body div[align="justify"] {
            text-align: justify !important;
            display: block !important;
        }

        /* תגים נוספים שעשויים לקבל יישור */
        .content-body ul[style*="text-align: center"],
        .content-body ol[style*="text-align: center"] {
            text-align: center !important;
            display: block !important;
        }

        /* תמיכה מיוחדת במובאות (blockquote) */
        .content-body blockquote {
            border-right: 4px solid var(--primary-color);
            padding: 0.5rem 1rem;
            margin: 1rem 0;
            background-color: rgba(0, 0, 0, 0.03);
        }

        /* תמיכה ברשימות */
        .content-body ul,
        .content-body ol {
            margin: 1rem 0 1rem 1.5rem;
        }

        .content-body li {
            margin-bottom: 0.5rem;
        }

        /* תמיכה בתוכן עשיר מהטופס המשודרג */
        .content-body .rich-text-content {
            /* כבר יש בסיס לתוכן עשיר */
        }

        /* אפשר גם לאכוף את הסגנונות שבאים מהטופס המשודרג */
        .content-body .color-forced .color-blue { color: #0066cc !important; }
        .content-body .color-forced .color-red { color: #ff0000 !important; }
        .content-body .color-forced .color-green { color: #008000 !important; }
        .content-body .color-forced .color-purple { color: #800080 !important; }
        .content-body .color-forced .color-purple-light { color: #9933ff !important; }
        .content-body .color-forced .color-orange { color: #ff6600 !important; }
        .content-body .color-forced .bg-yellow { background-color: #ffff00 !important; }
        .content-body .color-forced .bg-lightblue { background-color: #add8e6 !important; }
        .content-body .color-forced .bg-lightgreen { background-color: #90ee90 !important; }
        .content-body .color-forced .bg-pink { background-color: #ffc0cb !important; }
        .content-body .color-forced .bg-blue-dark { background-color: #0066cc !important; }
        
        footer {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
            padding: 1.5rem 0;
            text-align: center;
            margin-top: 2.5rem;
            box-shadow: 0 -2px 10px var(--shadow-color);
        }

        .copyright {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* מותאם למסכים קטנים */
        @media (max-width: 768px) {
            .header-flex {
                flex-direction: column;
                align-items: center;
            }
            
            .header-left, .header-right {
                width: 100%;
                text-align: center;
                margin-bottom: 0.5rem;
                justify-content: center;
            }
            
            .nav-links {
                padding: 0.5rem;
                justify-content: flex-start;
                overflow-x: auto;
            }
            
            .content-container {
                padding: 1rem;
            }
            
            .archive-items {
                grid-template-columns: 1fr;
            }
            
            .site-title {
                font-size: 1.5rem;
            }
            
            .page-title, .content-title {
                font-size: 1.4rem;
            }
            
            .parasha-selector, .hebrew-date, .parasha-banner {
                margin: 0.3rem;
                font-size: 0.85rem;
            }
            
            .content-meta {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
        }
        
        /* מותאם לטלפונים קטנים במיוחד */
        @media (max-width: 480px) {
            .site-title {
                font-size: 1.3rem;
            }
            
            .site-subtitle {
                font-size: 0.9rem;
            }
            
            .content-body {
                font-size: 1rem;
            }
            
            .content-card {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-flex">
                <div class="header-left">
                    <h1 class="site-title">דברי תורה שבועיים</h1>
                    <p class="site-subtitle">מאת סגל א' של רבני בתי הספר של החמ"ד</p>
                </div>
                <div class="header-right">
                    <div class="hebrew-date" id="hebrew-date">טוען תאריך עברי...</div>
                    <div class="parasha-banner" id="current-parasha-banner">
                        פרשת השבוע: <span id="current-parasha-name">טוען...</span>
                    </div>
                  <div class="parasha-selector">
                       <select id="parasha-select" onchange="loadParashaContent(this.value)">
                           <option value="">בחר פרשה...</option>
                           <!-- רשימת הפרשות תיטען באמצעות JavaScript -->
                       </select>
                   </div>
               </div>
           </div>
           
           <nav>
               <ul class="nav-links">
                   <li><a href="#" class="active" data-category="all">הכל</a></li>
                   <li><a href="#" data-category="divrei-torah">דבר תורה</a></li>
                   <li><a href="#" data-category="aktualya">אקטואליה</a></li>
                   <li><a href="#" data-category="values">ערכים</a></li>
                   <li><a href="#" data-category="language">שפה</a></li>
                   <li><a href="#" data-category="wisdom">פניני חוכמה</a></li>
                   <li><a href="#" data-category="empowerment">העצמה וכלים לחיים</a></li>
                   <li><a href="#" data-category="parasha">אתגר הפרשה</a></li>
                   <li><a href="#" data-category="creativity">יצירה</a></li>
                   <li><a href="#" data-category="mission">שליחות</a></li>
               </ul>
           </nav>
       </div>
   </header>

   <main class="container">
       <h2 class="page-title">דבר תורה לפרשת השבוע</h2>

       <div id="content-selector" class="content-selector">
           <!-- כאן יוצגו כרטיסיות של דברי תורה מרובים לפרשה -->
       </div>

       <div id="content-area">
           <div class="loading">טוען את דבר התורה</div>
       </div>

       <div class="archive-section">
           <h3 class="archive-title">דברי תורה מפרשות קודמות</h3>
           <div id="archive-items" class="archive-items">
               <!-- כאן יוצגו דברי תורה מפרשות קודמות -->
           </div>
       </div>
   </main>

   <footer>
       <div class="container">
           <p class="copyright">© כל הזכויות שמורות לבית הספר - 2025</p>
       </div>
   </footer>

   <script>
       // ========== הגדרות שיש לעדכן ==========
       // קישור לגיליון הנתונים (שנה קישור זה כשצריך)
       const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSL99eQJihGXzNWteo5ZxrfkMFme2u4_GilpBrq3I1dUhO8iTAz4DhZv_v6I4JgxZ034KTSLuIHAiFD/pub?output=csv';
       // ========================================

       // משתנה גלובלי לשמירת הקטגוריה הפעילה
       let activeCategory = 'all';
       // משתנה גלובלי לשמירת הפרשה הפעילה
       let activeParasha = '';

       // פונקציה לנרמול מקפים (ממיר מקפים מיוחדים למקף רגיל)
       function normalizeHyphens(text) {
           if (!text) return '';
           // החלף את המקף העברי (־) ומקפים מיוחדים אחרים במקף רגיל (-)
           return text.replace(/[\u05BE\u2010-\u2015\u2043\u2212]/g, '-');
       }

       // פונקציה להסרת ניקוד מטקסט עברי
       function removeHebrewNiqqud(text) {
           if (!text) return '';
           return text.replace(/[\u0591-\u05BD\u05BF-\u05C7]/g, '');
       }

       // פונקציה לקביעת פורמט תאריך במבנה YYYY-MM-DD
       function formatDate(date) {
           return date.toISOString().split('T')[0];
       }

       // פונקציה לחישוב תאריך השבת הקרובה
       function getParashaWeek(date) {
           const d = new Date(date);
           const day = d.getDay();
           const targetSaturday = new Date(d);
           const daysToAdd = (day === 6) ? 7 : (6 - day);
           targetSaturday.setDate(d.getDate() + daysToAdd);
           return formatDate(targetSaturday);
       }

       // פונקציה להצגת התאריך העברי
       async function displayHebrewDate() {
           try {
               const today = new Date();
               const dateUrl = `https://www.hebcal.com/converter?cfg=json&date=${formatDate(today)}&g2h=1&lg=he`;
               const response = await fetch(dateUrl);
               const data = await response.json();

               if (data && data.hebrew) {
                   // הסר ניקוד מהתאריך העברי
                   const hebrewDateWithoutNiqqud = removeHebrewNiqqud(data.hebrew);
                   const hebrewDateElem = document.getElementById('hebrew-date');
                   if (hebrewDateElem) {
                       hebrewDateElem.textContent = hebrewDateWithoutNiqqud;
                   }
               } else {
                   const hebrewDateElem = document.getElementById('hebrew-date');
                   if (hebrewDateElem) {
                       hebrewDateElem.textContent = 'לא ניתן להציג את התאריך העברי';
                   }
               }
           } catch (error) {
               console.error('שגיאה בחישוב התאריך העברי:', error);
               const hebrewDateElem = document.getElementById('hebrew-date');
               if (hebrewDateElem) {
                   hebrewDateElem.textContent = 'לא ניתן להציג את התאריך העברי';
               }
           }
       }

       // טבלת המרה של שמות פרשות מאנגלית לעברית
       const parashaTranslation = {
           'Bereshit': 'בראשית',
           'Noach': 'נח',
           'Lech-Lecha': 'לך לך',
           'Vayera': 'וירא',
           'Chayei Sara': 'חיי שרה',
           'Toldot': 'תולדות',
           'Vayetzei': 'ויצא',
           'Vayishlach': 'וישלח',
           'Vayeshev': 'וישב',
           'Miketz': 'מקץ',
           'Vayigash': 'ויגש',
           'Vayechi': 'ויחי',
           'Shemot': 'שמות',
           'Vaera': 'וארא',
           'Bo': 'בא',
           'Beshalach': 'בשלח',
           'Yitro': 'יתרו',
           'Mishpatim': 'משפטים',
           'Terumah': 'תרומה',
           'Tetzaveh': 'תצוה',
           'Ki Tisa': 'כי תשא',
           'Vayakhel': 'ויקהל',
           'Pekudei': 'פקודי',
           'Vayikra': 'ויקרא',
           'Tzav': 'צו',
           'Shmini': 'שמיני',
           'Tazria': 'תזריע',
           'Metzora': 'מצורע',
           'Achrei Mot': 'אחרי מות',
           'Kedoshim': 'קדושים',
           'Emor': 'אמור',
           'Behar': 'בהר',
           'Bechukotai': 'בחוקותי',
           'Bamidbar': 'במדבר',
           'Nasso': 'נשא',
           'Beha\'alotcha': 'בהעלותך',
           'Sh\'lach': 'שלח',
           'Korach': 'קרח',
           'Chukat': 'חקת',
           'Balak': 'בלק',
           'Pinchas': 'פינחס',
           'Matot': 'מטות',
           'Masei': 'מסעי',
           'Devarim': 'דברים',
           'Vaetchanan': 'ואתחנן',
           'Eikev': 'עקב',
           'Re\'eh': 'ראה',
           'Shoftim': 'שופטים',
           'Ki Teitzei': 'כי תצא',
           'Ki Tavo': 'כי תבוא',
           'Nitzavim': 'ניצבים',
           'Vayeilech': 'וילך',
           'Ha\'Azinu': 'האזינו',
           'Vezot Haberakhah': 'וזאת הברכה',
           // פרשות כפולות
           'Vayakhel-Pekudei': 'ויקהל-פקודי',
           'Tazria-Metzora': 'תזריע-מצורע',
           'Achrei Mot-Kedoshim': 'אחרי מות-קדושים',
           'Behar-Bechukotai': 'בהר-בחוקותי',
           'Chukat-Balak': 'חקת-בלק',
           'Matot-Masei': 'מטות-מסעי',
           'Nitzavim-Vayeilech': 'ניצבים-וילך'
       };

       // מיפוי שמות קטגוריות לשמות תצוגה בעברית
       const categoryLabels = {
           'divrei-torah': 'דבר תורה',
           'aktualya': 'אקטואליה',
           'values': 'ערכים',
           'language': 'שפה',
           'wisdom': 'פניני חוכמה',
           'empowerment': 'העצמה וכלים לחיים',
           'parasha': 'אתגר הפרשה',
           'creativity': 'יצירה',
           'mission': 'שליחות'
       };

       // מיפוי שמות תצוגה בעברית לקטגוריות באנגלית
       const categoryMapping = {
           'דבר תורה': 'divrei-torah',
           'דבר המפקח הארצי': 'divrei-torah',
           'אקטואליה': 'aktualya',
           'ערכים': 'values',
           'שפה': 'language',
           'פניני חוכמה': 'wisdom',
           'העצמה וכלים לחיים': 'empowerment',
           'אתגר הפרשה': 'parasha',
           'יצירה': 'creativity',
           'שליחות': 'mission'
       };

       // פונקציה לקביעת הפרשה הנוכחית לפי התאריך
       async function getCurrentParasha() {
           try {
               const today = new Date();
               const parashaDate = getParashaWeek(today);

               const parashaUrl = `https://www.hebcal.com/leyning?cfg=json&date=${parashaDate}`;
               const response = await fetch(parashaUrl);
               const data = await response.json();

               if (data?.items?.[0]?.name) {
                   // אם יש פרשה, החזר את השם העברי
                   if (data.items[0].name.he) {
                       // הסר ניקוד מהפרשה ונרמל מקפים
                       const parashah = removeHebrewNiqqud(data.items[0].name.he);
                       return normalizeHyphens(parashah);
                   }

                   // אם אין שם עברי, נסה להמיר מאנגלית
                   const englishName = data.items[0].name;
                   if (parashaTranslation[englishName]) {
                       return parashaTranslation[englishName];
                   }

                   // אם לא הצלחנו להמיר, החזר את השם באנגלית
                   return englishName;
               }

               // אם אין פרשה (יום חג למשל), נסה את השבת הבאה
               const nextWeek = new Date(today);
               nextWeek.setDate(today.getDate() + 7);
               const nextParashaDate = getParashaWeek(nextWeek);

               const nextParashaUrl = `https://www.hebcal.com/leyning?cfg=json&date=${nextParashaDate}`;
               const nextResponse = await fetch(nextParashaUrl);
               const nextData = await nextResponse.json();

               if (nextData?.items?.[0]?.name) {
                   if (nextData.items[0].name.he) {
                       const parashah = removeHebrewNiqqud(nextData.items[0].name.he);
                       return normalizeHyphens(parashah);
                   }

                   const nextEnglishName = nextData.items[0].name;
                   if (parashaTranslation[nextEnglishName]) {
                       return parashaTranslation[nextEnglishName];
                   }

                   return nextEnglishName;
               }

               // אם עדיין לא הצלחנו, החזר ברירת מחדל
               return "בראשית";
           } catch (error) {
               console.error('שגיאה בחישוב פרשת השבוע:', error);
               return "בראשית"; // ברירת מחדל במקרה של שגיאה
           }
       }

       // פונקציה לטעינת בחירת הפרשות
       async function loadParashotOptions() {
           const selectElement = document.getElementById('parasha-select');
           if (!selectElement) {
               console.error('לא נמצא אלמנט parasha-select');
               return "בראשית";
           }

           // ניקוי אפשרויות קיימות פרט לאפשרות הראשונה
           while (selectElement.options.length > 1) {
               selectElement.remove(1);
           }

           try {
               // קבל את הפרשה הנוכחית
               const currentParasha = await getCurrentParasha();
               activeParasha = currentParasha; // שמור את הפרשה הנוכחית

               // רשימת פרשות קבועה (ללא ניקוד)
               const parashot = [
                   "בראשית", "נח", "לך לך", "וירא", "חיי שרה", "תולדות", "ויצא", "וישלח", "וישב", "מקץ",
                   "ויגש", "ויחי", "שמות", "וארא", "בא", "בשלח", "יתרו", "משפטים", "תרומה", "תצוה",
                   "כי תשא", "ויקהל", "פקודי", "ויקרא", "צו", "שמיני", "תזריע", "מצורע", "אחרי מות", "קדושים",
                   "אמור", "בהר", "בחוקותי", "במדבר", "נשא", "בהעלותך", "שלח", "קרח", "חקת", "בלק",
                   "פינחס", "מטות", "מסעי", "דברים", "ואתחנן", "עקב", "ראה", "שופטים", "כי תצא", "כי תבוא",
                   "ניצבים", "וילך", "האזינו", "וזאת הברכה",
                   // פרשות כפולות
                   "ויקהל-פקודי", "תזריע-מצורע", "אחרי מות-קדושים", "בהר-בחוקותי",
                   "חקת-בלק", "מטות-מסעי", "ניצבים-וילך"
               ];

               // מילוי אפשרויות הבחירה
               parashot.forEach(parasha => {
                   const option = document.createElement('option');
                   option.value = parasha;
                   option.textContent = parasha;

                   // סמן את הפרשה הנוכחית כנבחרת
                   if (normalizeHyphens(parasha) === normalizeHyphens(currentParasha)) {
                       option.selected = true;
                   }

                   selectElement.appendChild(option);
               });

               // עדכון שם הפרשה בכותרת
               const parashaNameElem = document.getElementById('current-parasha-name');
               if (parashaNameElem) {
                   parashaNameElem.textContent = currentParasha;
               }
               
               const pageTitleElem = document.querySelector('.page-title');
               if (pageTitleElem) {
                   pageTitleElem.textContent = `דבר תורה לפרשת ${currentParasha}`;
               }

               return currentParasha;
           } catch (error) {
               console.error('שגיאה בטעינת הפרשות:', error);
               return "בראשית"; // ברירת מחדל
           }
       }

       // פונקציה לטעינת התוכן מגוגל שיטס - מעודכנת לטיפול בקטגוריות ואינדקסים חדשים
       async function loadParashaContent(parashaName = null, category = null) {
           try {
               // אם נבחרה קטגוריה חדשה, עדכן את הקטגוריה הפעילה
               if (category !== null) {
                   activeCategory = category;

                   // עדכן את ה-UI לפי הקטגוריה הנבחרת
                   document.querySelectorAll('.nav-links a').forEach(link => {
                       link.classList.remove('active');
                   });
                   
                   // בדוק שהאלמנט קיים לפני הוספת מחלקה
                   const activeLink = document.querySelector(`.nav-links a[data-category="${activeCategory}"]`);
                   if (activeLink) {
                       activeLink.classList.add('active');
                   }

                   // עדכן את ערכת הצבעים באמצעות מאפיין data
                   document.body.setAttribute('data-active-category', activeCategory === 'all' ? '' : activeCategory);
               }

               // קבל את הפרשה הנוכחית אם לא נבחרה פרשה ספציפית
               if (!parashaName) {
                   parashaName = activeParasha || await getCurrentParasha();
               } else {
                   activeParasha = parashaName; // עדכון הפרשה הפעילה
               }

               // נרמל מקפים בשם הפרשה
               parashaName = normalizeHyphens(parashaName);

               // עדכון שם הפרשה בכותרת
               const parashaNameElem = document.getElementById('current-parasha-name');
               if (parashaNameElem) {
                   parashaNameElem.textContent = parashaName;
               }

               // עדכון כותרת העמוד לפי הקטגוריה הנבחרת
               const pageTitleElem = document.querySelector('.page-title');
               if (pageTitleElem) {
                   if (activeCategory === 'all') {
                       pageTitleElem.textContent = `דבר תורה לפרשת ${parashaName}`;
                   } else {
                       const categoryLabel = categoryLabels[activeCategory] || activeCategory;
                       pageTitleElem.textContent = `${categoryLabel} - פרשת ${parashaName}`;
                   }
               }

               // טען את הנתונים מהגיליון
               const url = SHEET_URL;
               const response = await fetch(url);
               const csvText = await response.text();
               const rows = parseCSV(csvText);

               console.log("טעינת נתונים מהגיליון, פרשה:", parashaName, "קטגוריה:", activeCategory);

               // רשימת פרשות לחיפוש - בהתחלה רק הפרשה עצמה
               let parashaList = [parashaName];

               // אם זו פרשה כפולה, פצל אותה לפרשות הבודדות
               if (parashaName.includes('-')) {
                   const parts = parashaName.split('-');

                   // הוסף את הפרשות הבודדות
                   parashaList = [...parashaList, parts[0].trim(), parts[1].trim()];
                   console.log(`פרשה כפולה זוהתה: ${parashaName}, מחפש את: ${parashaList.join(', ')}`);
               }

               // מערך שיכיל את כל התוצאות
               let allResults = [];

               // בצע חיפוש לכל פרשה
               for (const searchParasha of parashaList) {
                   console.log(`מחפש תוכן עבור פרשת ${searchParasha}`);

                   // סינון תוצאות עבור פרשה נוכחית וקטגוריה נוכחית
                   // לפי סדר העמודות החדש: A:זמן הגשה (0), B:פרשה (1), C:כותרת (2), D:תוכן לא רלוונטי (3), 
                   // E:תוכן (4), F:שם הכותב (5), G:שנה (6), H:קטגוריה (7), I:זמין (8)
                   const results = rows.filter(row => {
                       if (row.length < 9) return false; // ודא שיש מספיק עמודות (כולל עמודת הזמינות)

                       // ודא שהרשומה זמינה (עמודה I - אינדקס 8)
                       const isAvailable = (
                           row[8]?.trim().toLowerCase() === "כן" ||
                           row[8]?.trim().toLowerCase() === "yes" ||
                           row[8]?.trim() === "1" ||
                           row[8]?.trim().toLowerCase() === "true"
                       );

                       if (!isAvailable) return false;

                       // נרמל מקפים בשם הפרשה מהשורה (עמודה B - אינדקס 1)
                       const normalizedRowParasha = normalizeHyphens(row[1]?.trim() || '');

                       // בדוק התאמה לפרשה הנוכחית
                       const matchesParasha = normalizedRowParasha === searchParasha;

                       if (!matchesParasha) return false;

                       // קבל את הקטגוריה מהשורה (עמודה H - אינדקס 7)
                       const rowCategory = row[7]?.trim() || '';

                       // המר את הקטגוריה העברית למזהה באנגלית אם צריך
                       const categoryKey = categoryMapping[rowCategory] || rowCategory.toLowerCase();

                       // בדוק התאמה לקטגוריה
                       if (activeCategory === 'all') {
                           return true; // כל הקטגוריות מתאימות
                       } else {
                           return categoryKey === activeCategory;
                       }
                   });

                   console.log(`נמצאו ${results.length} תוצאות עבור פרשת ${searchParasha} בקטגוריה ${activeCategory}`);

                   // הוסף את התוצאות למערך הכולל
                   allResults = [...allResults, ...results];
               }

               console.log(`סך הכל נמצאו ${allResults.length} רשומות לפרשת ${parashaName} בקטגוריה ${activeCategory}`);

               // הייחס לאלמנט content-area
               const contentArea = document.getElementById('content-area');
               if (!contentArea) {
                   console.error('לא נמצא אלמנט content-area');
                   return;
               }

               // אם יש רשומות, הצג אותן
               if (allResults.length > 0) {
                   // הצג את הראשונה כתוכן ראשי
                   displayContent(allResults[0]);

                   // הצג בוחר תוכן אם יש יותר מרשומה אחת
                   const selectorContainer = document.getElementById('content-selector');
                   if (selectorContainer) {
                       if (allResults.length > 1) {
                           displayContentSelector(allResults, 0); // האינדקס הראשון פעיל כברירת מחדל
                           selectorContainer.style.display = 'flex'; // וודא שהבוחר מוצג
                       } else {
                           // אם יש רק רשומה אחת, וודא שבוחר התוכן מוסתר
                           selectorContainer.style.display = 'none';
                       }
                   }
               } else {
                   // אם אין רשומות, הצג הודעה מתאימה
                   let message = '';
                   if (activeCategory !== 'all') {
                       message = `אין כרגע דבר תורה בקטגוריית "${categoryLabels[activeCategory]}" לפרשת ${parashaName}.`;
                   } else {
                       message = `אין כרגע דבר תורה זמין לפרשת ${parashaName}.`;
                   }

                   contentArea.innerHTML = `
                       <div class="content-container">
                           <div class="content-header">
                               <h3 class="content-title">אין תוכן זמין</h3>
                           </div>
                           <div class="content-body">
                               <p>${message}</p>
                           </div>
                       </div>
                   `;

                   // הסתר בוחר התוכן
                   const selectorContainer = document.getElementById('content-selector');
                   if (selectorContainer) {
                       selectorContainer.style.display = 'none';
                   }
               }

               // טעינת ארכיון פרשות קודמות (מפרשות שונות) - רק פריטים זמינים וגם לפי קטגוריה
               // לפי סדר העמודות החדש: A:זמן הגשה (0), B:פרשה (1), C:כותרת (2), D:תוכן לא רלוונטי (3), 
               // E:תוכן (4), F:שם הכותב (5), G:שנה (6), H:קטגוריה (7), I:זמין (8)
               const otherParashot = rows.filter(row => {
                   if (row.length < 9) return false;

                   // ודא שהרשומה זמינה (עמודה I - אינדקס 8)
                   const isAvailable = (
                       row[8]?.trim().toLowerCase() === "כן" ||
                       row[8]?.trim().toLowerCase() === "yes" ||
                       row[8]?.trim() === "1" ||
                       row[8]?.trim().toLowerCase() === "true"
                   );

                   if (!isAvailable) return false;

                   // נרמל מקפים בשם הפרשה מהשורה (עמודה B - אינדקס 1)
                   const normalizedRowParasha = normalizeHyphens(row[1]?.trim() || '');

                   // בדוק שהפרשה לא אחת מהפרשות שאנחנו כבר מציגים
                   const differentParasha = !parashaList.includes(normalizedRowParasha);

                   if (!differentParasha) return false;

                   // קבל את הקטגוריה מהשורה (עמודה H - אינדקס 7)
                   const rowCategory = row[7]?.trim() || '';

                   // המר את הקטגוריה העברית למזהה באנגלית אם צריך
                   const categoryKey = categoryMapping[rowCategory] || rowCategory.toLowerCase();

                   // בדוק התאמה לקטגוריה
                   if (activeCategory === 'all') {
                       return true; // כל הקטגוריות מתאימות
                   } else {
                       return categoryKey === activeCategory;
                   }
               });

               loadArchiveItems(otherParashot);

           } catch (error) {
               console.error('Error loading content:', error);
               const contentArea = document.getElementById('content-area');
               if (contentArea) {
                   contentArea.innerHTML = `
                       <div class="content-container">
                           <div class="content-header">
                               <h3 class="content-title">שגיאה בטעינת התוכן</h3>
                           </div>
                           <div class="content-body">
                               <p>לא ניתן לטעון את התוכן כרגע. אנא נסה שוב מאוחר יותר.</p>
                               <p>פרטי השגיאה: ${error.message}</p>
                           </div>
                       </div>
                   `;
               }
           }
       }

       // פונקציה להצגת בוחר התוכן כשיש מספר דברי תורה לאותה פרשה
       function displayContentSelector(entries, activeIndex) {
           const selectorContainer = document.getElementById('content-selector');
           if (!selectorContainer) return;

           selectorContainer.innerHTML = '';
           selectorContainer.style.display = 'flex';

           entries.forEach((entry, index) => {
               // לפי סדר העמודות החדש: A:זמן הגשה (0), B:פרשה (1), C:כותרת (2), D:תוכן לא רלוונטי (3), 
               // E:תוכן (4), F:שם הכותב (5), G:שנה (6), H:קטגוריה (7), I:זמין (8)
               const [timestamp, parasha, title, contentNotUsed, content, author, year, category, isAvailable] = entry;

               const card = document.createElement('div');
               card.className = `content-card ${index === activeIndex ? 'active' : ''}`;

               // בניית תוכן הכרטיסיה כולל תווית הקטגוריה
               let cardContent = `<h4>${title}</h4>`;

               // הוסף תווית קטגוריה אם קיימת
               if (category) {
                   const categoryKey = categoryMapping[category] || category.toLowerCase();
                   const displayCategory = category;
                   cardContent += `<span class="category-label">${displayCategory}</span>`;
               }

               cardContent += `<p>מאת: ${author}</p>`;

               // הוסף תווית שנה אם קיימת
               if (year) {
                   cardContent += `<span class="year-tag">${year}</span>`;
               }

               card.innerHTML = cardContent;

               card.addEventListener('click', function() {
                   // הסר את המחלקה 'active' מכל הכרטיסיות
                   document.querySelectorAll('.content-card').forEach(c => c.classList.remove('active'));
                   // הוסף את המחלקה 'active' לכרטיסיה הנוכחית
                   this.classList.add('active');
                   // הצג את התוכן המתאים
                   displayContent(entries[index]);
               });

               selectorContainer.appendChild(card);
           });
       }

       // פונקציה משופרת לפרסור CSV שמטפלת טוב יותר בשורות עם תוכן מרובה שורות
       function parseCSV(text) {
           const rows = [];
           const lines = text.split('\n');
           
           console.log("מספר שורות בקובץ CSV:", lines.length);
           
           // נדלג על שורת הכותרות
           let currentRow = [];
           let currentValue = '';
           let inQuotes = false;
           
           // עיבוד כל השורות
           for (let i = 1; i < lines.length; i++) {
               const line = lines[i];
               
               // דלג על שורות ריקות
               if (!inQuotes && line.trim() === '') continue;
               
               // עיבוד כל תו בשורה
               for (let j = 0; j < line.length; j++) {
                   const char = line[j];
                   
                   if (char === '"') {
                       // טיפול במרכאות - החלף את מצב המרכאות
                       inQuotes = !inQuotes;
                   } else if (char === ',' && !inQuotes) {
                       // סיום תא - הוסף את הערך הנוכחי לשורה
                       currentRow.push(currentValue);
                       currentValue = '';
                   } else {
                       // הוסף את התו לערך הנוכחי
                       currentValue += char;
                   }
               }
               
               // אם אנחנו לא בתוך מרכאות, זה סוף השורה
               if (!inQuotes) {
                   // הוסף את התא האחרון
                   currentRow.push(currentValue);
                   // הוסף את השורה למערך התוצאות
                   rows.push(currentRow);
                   // איפוס למעבר לשורה הבאה
                   currentRow = [];
                   currentValue = '';
               } else {
                   // אם אנחנו בתוך מרכאות, הוסף שורה חדשה לערך הנוכחי
                   currentValue += '\n';
               }
           }
           
           // אם יש שורה אחרונה שלא הסתיימה
           if (currentRow.length > 0 || currentValue.length > 0) {
               currentRow.push(currentValue);
               rows.push(currentRow);
           }
           
           return rows;
       }

       // פונקציה משופרת להצגת התוכן הראשי בעמוד
       function displayContent(contentRow) {
           // הייחס לאלמנט content-area
           const contentArea = document.getElementById('content-area');
           if (!contentArea) return;

           // לפי סדר העמודות החדש: A:זמן הגשה (0), B:פרשה (1), C:כותרת (2), D:תוכן לא רלוונטי (3), 
           // E:תוכן (4), F:שם הכותב (5), G:שנה (6), H:קטגוריה (7), I:זמין (8)
           const [timestamp, parasha, title, contentNotUsed, content, author, year, category, isAvailable] = contentRow;

           // הכנת תצוגת הקטגוריה
           let categoryHtml = '';
           if (category) {
               const categoryKey = categoryMapping[category] || category.toLowerCase();
               categoryHtml = `<span class="category-label">${category}</span>`;
           }

           // פורמט לתאריך הגשה
           let timestampFormatted = '';
           if (timestamp) {
               try {
                   const date = new Date(timestamp);
                   if (!isNaN(date.getTime())) {
                       timestampFormatted = date.toLocaleDateString('he-IL');
                   } else {
                       timestampFormatted = timestamp;
                   }
               } catch (e) {
                   timestampFormatted = timestamp;
               }
           }

           // פונקציה משופרת לשיפור תצוגת התוכן עם תמיכה בעיצובים
           function enhanceContentDisplay(htmlContent) {
               // וודא שזה לא ריק
               if (!htmlContent || htmlContent.trim() === '') {
                   return '<p>אין תוכן זמין.</p>';
               }
               
               // בדוק אם התוכן כבר מכיל div עם class="rich-text-content"
               if (htmlContent.includes('class="rich-text-content"')) {
                   // אם כן, החזר אותו כמו שהוא (כבר מעוצב מהטופס)
                   return htmlContent;
               }

               // אחרת, שפר את התוכן
               let processedHtml = htmlContent;
               
               // חיזוק יישורי טקסט
               processedHtml = processedHtml
                   // מרכוז
                   .replace(/<p style="text-align: center/g, '<p style="text-align: center !important; display: block;" align="center"')
                   .replace(/<h([1-6]) style="text-align: center/g, '<h$1 style="text-align: center !important; display: block;" align="center"')
                   .replace(/<div style="text-align: center/g, '<div style="text-align: center !important; display: block;" align="center"')
                   .replace(/<blockquote style="text-align: center/g, '<blockquote style="text-align: center !important; display: block;" align="center"')
                   
                   // יישור לימין
                   .replace(/<p style="text-align: right/g, '<p style="text-align: right !important; display: block;" align="right"')
                   .replace(/<h([1-6]) style="text-align: right/g, '<h$1 style="text-align: right !important; display: block;" align="right"')
                   .replace(/<div style="text-align: right/g, '<div style="text-align: right !important; display: block;" align="right"')
                   .replace(/<blockquote style="text-align: right/g, '<blockquote style="text-align: right !important; display: block;" align="right"')
                   
                   // יישור לשמאל
                   .replace(/<p style="text-align: left/g, '<p style="text-align: left !important; display: block;" align="left"')
                   .replace(/<h([1-6]) style="text-align: left/g, '<h$1 style="text-align: left !important; display: block;" align="left"')
                   .replace(/<div style="text-align: left/g, '<div style="text-align: left !important; display: block;" align="left"')
                   .replace(/<blockquote style="text-align: left/g, '<blockquote style="text-align: left !important; display: block;" align="left"')

                   // יישור מלא
                   .replace(/<p style="text-align: justify/g, '<p style="text-align: justify !important; display: block;" align="justify"')
                   .replace(/<h([1-6]) style="text-align: justify/g, '<h$1 style="text-align: justify !important; display: block;" align="justify"')
                   .replace(/<div style="text-align: justify/g, '<div style="text-align: justify !important; display: block;" align="justify"')
                   .replace(/<blockquote style="text-align: justify/g, '<blockquote style="text-align: justify !important; display: block;" align="justify"')

                   // חיזוק תמיכה במחלקות יישור של Quill
                   .replace(/<p class="ql-align-center/g, '<p class="ql-align-center" style="text-align: center !important; display: block;" align="center"')
                   .replace(/<p class="ql-align-right/g, '<p class="ql-align-right" style="text-align: right !important; display: block;" align="right"')
                   .replace(/<p class="ql-align-left/g, '<p class="ql-align-left" style="text-align: left !important; display: block;" align="left"')
                   .replace(/<p class="ql-align-justify/g, '<p class="ql-align-justify" style="text-align: justify !important; display: block;" align="justify"')
                   
                   // חיזוק תמיכה בכיוון טקסט
                   .replace(/<p class="ql-direction-rtl/g, '<p class="ql-direction-rtl" dir="rtl" style="direction: rtl !important;')
                   .replace(/<blockquote class="ql-direction-rtl/g, '<blockquote class="ql-direction-rtl" dir="rtl" style="direction: rtl !important;')
                   .replace(/<li class="ql-direction-rtl/g, '<li class="ql-direction-rtl" dir="rtl" style="direction: rtl !important;')
                   
                   // חיזוק צבעים ספציפיים
                   .replace(/color: red/g, 'color: red !important')
                   .replace(/color: blue/g, 'color: blue !important')
                   .replace(/color: green/g, 'color: green !important')
                   .replace(/color: purple/g, 'color: purple !important')
                   .replace(/color: orange/g, 'color: orange !important')
                   .replace(/color: yellow/g, 'color: #806600 !important') // צהוב כהה יותר לקריאות
                   
                   // חיזוק צבעי רקע
                   .replace(/background-color: yellow/g, 'background-color: yellow !important')
                   .replace(/background-color: lightblue/g, 'background-color: lightblue !important')
                   .replace(/background-color: lightgreen/g, 'background-color: lightgreen !important')
                   .replace(/background-color: pink/g, 'background-color: pink !important')
                   .replace(/background-color: rgb\(0, 102, 204\)/g, 'background-color: #0066cc !important')
                   .replace(/background-color: rgb\(153, 51, 255\)/g, 'background-color: #9933ff !important');

               // וודא שיש עטיפה כוללת שמאפשרת סגנונות
               return '<div class="rich-text-content enhanced-content">' + processedHtml + '</div>';
           }

           // שיפור תצוגת התוכן לפני הצגה
           const enhancedContent = enhanceContentDisplay(content);

           const contentHtml = `
               <div class="content-container">
                   <div class="content-header">
                       <h3 class="content-title">
                           ${year ? `<span class="year-badge">${year}</span>` : ''}
                           ${title}
                       </h3>
                       <div class="content-meta">
                           ${categoryHtml}
                           <span>מאת: ${author}</span>
                           ${timestamp ? `<span> | נכתב בתאריך: ${timestampFormatted}</span>` : ''}
                       </div>
                   </div>
                   <div class="content-body">
                       ${enhancedContent}
                   </div>
               </div>
           `;

           contentArea.innerHTML = contentHtml;
       }

       // טעינת ארכיון פרשות קודמות - מעודכן לסדר העמודות החדש
       function loadArchiveItems(rows) {
           const archiveContainer = document.getElementById('archive-items');
           if (!archiveContainer) return;

           archiveContainer.innerHTML = '';

           // מיון השורות לפי תאריך הגשה (מהחדש לישן)
           rows.sort((a, b) => {
               if (a.length < 1 || b.length < 1) return 0;
               const dateA = new Date(a[0]);
               const dateB = new Date(b[0]);
               return dateB - dateA;
           });

           // מספר מוגבל של פריטים להצגה בארכיון
           const maxItems = 6;
           let count = 0;

           for (const row of rows) {
               // ודא שיש מספיק עמודות בשורה
               if (row.length < 9) continue;

               // לפי סדר העמודות החדש: A:זמן הגשה (0), B:פרשה (1), C:כותרת (2), D:תוכן לא רלוונטי (3), 
               // E:תוכן (4), F:שם הכותב (5), G:שנה (6), H:קטגוריה (7), I:זמין (8)
               const [timestamp, parasha, title, contentNotUsed, content, author, year, category, isAvailable] = row;

               // דלג על שורות לא תקינות
               if (!parasha || !title) continue;

               // הגבלת מספר הפריטים
               if (count >= maxItems) break;

               // הכנת תצוגת הקטגוריה
               let categoryHtml = '';
               if (category) {
                   const displayCategory = category;
                   categoryHtml = `<span class="category-label">${displayCategory}</span>`;
               }

               const archiveItem = document.createElement('div');
               archiveItem.className = 'archive-item';
               archiveItem.innerHTML = `
                   <h4>${title}</h4>
                   <p>פרשת ${parasha} ${year ? `(${year})` : ''}</p>
                   <p>${categoryHtml} מאת: ${author}</p>
                   <a href="#" onclick="selectParashaAndCategory('${parasha}', '${categoryMapping[category] || category?.toLowerCase() || 'all'}'); return false;">לקריאה</a>
               `;

               archiveContainer.appendChild(archiveItem);
               count++;
           }

           if (count === 0) {
               let message = '';
               if (activeCategory !== 'all') {
                   const categoryLabel = categoryLabels[activeCategory] || activeCategory;
                   message = `אין דברי תורה קודמים בקטגוריית ${categoryLabel} בארכיון.`;
               } else {
                   message = 'אין דברי תורה קודמים בארכיון.';
               }

               archiveContainer.innerHTML = `<p style="text-align: center; grid-column: 1/-1;">${message}</p>`;
           }
       }

       // פונקציה לבחירת פרשה וקטגוריה בבת אחת
       function selectParashaAndCategory(parasha, category) {
           try {
               // עדכן את הפרשה הנבחרת בתיבת הבחירה
               const selectElement = document.getElementById('parasha-select');
               if (selectElement) {
                   for (let i = 0; i < selectElement.options.length; i++) {
                       if (selectElement.options[i].value === parasha) {
                           selectElement.selectedIndex = i;
                           break;
                       }
                   }
               }

               // טען את התוכן לפי הפרשה והקטגוריה שנבחרו
               loadParashaContent(parasha, category);
           } catch (error) {
               console.error('שגיאה בבחירת פרשה וקטגוריה:', error);
               alert('אירעה שגיאה בעת ניסיון לבחור את הפרשה והקטגוריה. אנא נסה שוב.');
           }
       }

       // הוסף ניהול אירועי קטגוריה
       function setupCategoryHandlers() {
           document.querySelectorAll('.nav-links a').forEach(link => {
               link.addEventListener('click', function(e) {
                   e.preventDefault();
                   const category = this.getAttribute('data-category');
                   if (category) {
                       // טען תוכן חדש לפי הקטגוריה הנבחרת
                       loadParashaContent(activeParasha, category);
                   }
               });
           });
       }

       // אתחול הדף כשהוא נטען
       window.addEventListener('DOMContentLoaded', async () => {
           try {
               // הצג תאריך עברי
               await displayHebrewDate();

               // טען את רשימת הפרשות עם הפרשה הנוכחית מסומנת
               const currentParasha = await loadParashotOptions();

               // הגדר מטפלי אירועים לקטגוריות
               setupCategoryHandlers();

               // טען את התוכן של הפרשה הנוכחית
               await loadParashaContent(currentParasha, 'all');
           } catch (error) {
               console.error('שגיאה באתחול הדף:', error);
               // טען גרסה פשוטה במקרה של שגיאה
               const pageTitleElem = document.querySelector('.page-title');
               if (pageTitleElem) {
                   pageTitleElem.textContent = 'דבר תורה לפרשת השבוע';
               }
               
               const parashaNameElem = document.getElementById('current-parasha-name');
               if (parashaNameElem) {
                   parashaNameElem.textContent = 'בראשית';
               }
               
               try {
                   loadParashaContent('בראשית', 'all');
               } catch (innerError) {
                   console.error('שגיאה בטעינת תוכן גיבוי:', innerError);
                   const contentArea = document.getElementById('content-area');
                   if (contentArea) {
                       contentArea.innerHTML = `
                           <div class="content-container">
                               <div class="content-header">
                                   <h3 class="content-title">שגיאה בטעינת התוכן</h3>
                               </div>
                               <div class="content-body">
                                   <p>לא ניתן לטעון את התוכן כרגע. אנא נסה לרענן את הדף.</p>
                               </div>
                           </div>
                       `;
                   }
               }
           }
       });
   </script>
</body>
</html>
