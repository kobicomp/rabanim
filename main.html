<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>דברי תורה שבועיים - מבואה</title>
    <link rel="icon" href="data:,">
    <style>
        :root {
            --primary-color: #3f51b5;
            --accent-color: #ff9800;
            --bg-color: #f8f9fa;
            --text-color: #333;
            --header-bg: #f0f4f8;
            --footer-bg: #e1e5eb;
            --border-color: #ddd;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        header {
            background-color: var(--header-bg);
            padding: 1rem 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .site-title {
            font-size: 2.2rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            text-align: center;
        }
        
        .site-subtitle {
            font-size: 1.2rem;
            text-align: center;
            margin-bottom: 1rem;
            color: #555;
        }
        
        .hebrew-date {
            text-align: center;
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 0.8rem;
        }
        
        .parasha-banner {
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            padding: 10px 0;
            font-size: 1.3rem;
            margin-top: 1rem;
        }
        
        .parasha-selector {
            text-align: center;
            margin: 10px 0;
        }
        
        .parasha-selector select {
            padding: 8px 15px;
            font-size: 1rem;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            background-color: white;
            cursor: pointer;
            min-width: 200px;
        }
        
        .content-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 1rem 0;
            justify-content: center;
        }
        
        .content-card {
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 10px;
            min-width: 200px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .content-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .content-card.active {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(63, 81, 181, 0.3);
        }
        
        .content-card h4 {
            margin: 0 0 5px 0;
            font-size: 1rem;
            color: var(--primary-color);
        }
        
        .content-card p {
            margin: 0;
            font-size: 0.8rem;
            color: #666;
        }
        
        .content-card .year-tag {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
            margin-top: 5px;
        }
        
        nav {
            display: flex;
            justify-content: center;
            margin-top: 1rem;
            border-top: 1px solid var(--border-color);
            padding-top: 1rem;
        }
        
        .nav-links {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            list-style: none;
            gap: 20px;
        }
        
        .nav-links li a {
            display: block;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        
        .nav-links li a:hover,
        .nav-links li a.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        main {
            padding: 2rem 0;
        }
        
        .page-title {
            text-align: center;
            margin-bottom: 2rem;
            color: var(--primary-color);
            font-size: 2rem;
        }
        
        .content-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .content-header {
            border-bottom: 2px solid var(--primary-color);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
        }
        
        .content-title {
            font-size: 1.6rem;
            color: var(--primary-color);
        }
        
        .content-meta {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.5rem;
        }
        
        .year-badge {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-right: 10px;
        }
        
        .content-body {
            line-height: 1.8;
            font-size: 1.1rem;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            font-size: 1.2rem;
            color: #777;
        }
        
        footer {
            background-color: var(--footer-bg);
            padding: 1.5rem 0;
            text-align: center;
            margin-top: 2rem;
            border-top: 1px solid var(--border-color);
        }
        
        .copyright {
            font-size: 0.9rem;
            color: #555;
        }
        
        .archive-section {
            margin-top: 3rem;
        }
        
        .archive-title {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .archive-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 1.5rem;
        }
        
        .archive-item {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            transition: transform 0.3s ease;
        }
        
        .archive-item:hover {
            transform: translateY(-5px);
        }
        
        .archive-item h4 {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        .archive-item p {
            font-size: 0.9rem;
            color: #666;
        }
        
        .archive-item a {
            display: inline-block;
            margin-top: 0.5rem;
            color: var(--accent-color);
            text-decoration: none;
        }
        
        .archive-item a:hover {
            text-decoration: underline;
        }
        
        @media (max-width: 768px) {
            .nav-links {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }
            
            .content-container {
                padding: 1rem;
            }
            
            .archive-items {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1 class="site-title">דברי תורה שבועיים</h1>
            <p class="site-subtitle">מאת רבני בית הספר</p>
            
            <!-- הוספת תצוגת תאריך עברי -->
            <div class="hebrew-date" id="hebrew-date">טוען תאריך עברי...</div>
            
            <div class="parasha-banner" id="current-parasha-banner">
                פרשת השבוע: <span id="current-parasha-name">טוען...</span>
            </div>
            
            <div class="parasha-selector">
                <select id="parasha-select" onchange="loadParashaContent(this.value)">
                    <option value="">בחר פרשה...</option>
                    <!-- רשימת הפרשות תיטען באמצעות JavaScript -->
                </select>
            </div>
            
            <nav>
                <ul class="nav-links">
                    <li><a href="index.html" class="active">מבואה</a></li>
                    <li><a href="aktualya.html">אקטואליה</a></li>
                    <li><a href="values.html">ערכים</a></li>
                    <li><a href="language.html">שפה</a></li>
                    <li><a href="wisdom.html">פניני חוכמה</a></li>
                    <li><a href="empowerment.html">העצמה וכלים לחיים</a></li>
                    <li><a href="parasha.html">אתגר הפרשה</a></li>
                    <li><a href="creativity.html">יצירה</a></li>
                    <li><a href="mission.html">שליחות</a></li>
                </ul>
            </nav>
        </div>
    </header>
    
    <main class="container">
        <h2 class="page-title">דבר תורה לפרשת השבוע</h2>
        
        <div id="content-selector" class="content-selector">
            <!-- כאן יוצגו כרטיסיות של דברי תורה מרובים לפרשה -->
        </div>
        
        <div id="content-area">
            <div class="loading">טוען את דבר התורה...</div>
        </div>
        
        <div class="archive-section">
            <h3 class="archive-title">דברי תורה מפרשות קודמות</h3>
            <div id="archive-items" class="archive-items">
                <!-- כאן יוצגו דברי תורה מפרשות קודמות -->
            </div>
        </div>
    </main>
    
    <footer>
        <div class="container">
            <p class="copyright">© כל הזכויות שמורות לבית הספר - 2025</p>
        </div>
    </footer>
    
    <script>
        // ========== הגדרות שיש לעדכן ==========
        // קישור לגיליון הנתונים (שנה קישור זה כשצריך)
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSuqfhHb4HdLcP3WLMT33O61cP_5bQrryiZ-qVSPiAfQNaWCi32iNePVcOdFM7faykcbUX-FpoTuYdE/pub?output=csv';
        // ========================================
        
        // פונקציה להסרת ניקוד מטקסט עברי
        function removeHebrewNiqqud(text) {
            if (!text) return '';
            return text.replace(/[\u0591-\u05BD\u05BF-\u05C7]/g, '');
        }
        
        // פונקציה לקביעת פורמט תאריך במבנה YYYY-MM-DD
        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        // פונקציה לחישוב תאריך השבת הקרובה
        function getParashaWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const targetSaturday = new Date(d);
            const daysToAdd = (day === 6) ? 7 : (6 - day);
            targetSaturday.setDate(d.getDate() + daysToAdd);
            return formatDate(targetSaturday);
        }
        
        // פונקציה להצגת התאריך העברי
        async function displayHebrewDate() {
            try {
                const today = new Date();
                const dateUrl = `https://www.hebcal.com/converter?cfg=json&date=${formatDate(today)}&g2h=1&lg=he`;
                const response = await fetch(dateUrl);
                const data = await response.json();
                
                if (data && data.hebrew) {
                    // הסר ניקוד מהתאריך העברי
                    const hebrewDateWithoutNiqqud = removeHebrewNiqqud(data.hebrew);
                    document.getElementById('hebrew-date').textContent = hebrewDateWithoutNiqqud;
                } else {
                    document.getElementById('hebrew-date').textContent = 'לא ניתן להציג את התאריך העברי';
                }
            } catch (error) {
                console.error('שגיאה בחישוב התאריך העברי:', error);
                document.getElementById('hebrew-date').textContent = 'לא ניתן להציג את התאריך העברי';
            }
        }
        
        // טבלת המרה של שמות פרשות מאנגלית לעברית
        const parashaTranslation = {
            'Bereshit': 'בראשית',
            'Noach': 'נח',
            'Lech-Lecha': 'לך לך',
            'Vayera': 'וירא',
            'Chayei Sara': 'חיי שרה',
            'Toldot': 'תולדות',
            'Vayetzei': 'ויצא',
            'Vayishlach': 'וישלח',
            'Vayeshev': 'וישב',
            'Miketz': 'מקץ',
            'Vayigash': 'ויגש',
            'Vayechi': 'ויחי',
            'Shemot': 'שמות',
            'Vaera': 'וארא',
            'Bo': 'בא',
            'Beshalach': 'בשלח',
            'Yitro': 'יתרו',
            'Mishpatim': 'משפטים',
            'Terumah': 'תרומה',
            'Tetzaveh': 'תצוה',
            'Ki Tisa': 'כי תשא',
            'Vayakhel': 'ויקהל',
            'Pekudei': 'פקודי',
            'Vayikra': 'ויקרא',
            'Tzav': 'צו',
            'Shmini': 'שמיני',
            'Tazria': 'תזריע',
            'Metzora': 'מצורע',
            'Achrei Mot': 'אחרי מות',
            'Kedoshim': 'קדושים',
            'Emor': 'אמור',
            'Behar': 'בהר',
            'Bechukotai': 'בחוקותי',
            'Bamidbar': 'במדבר',
            'Nasso': 'נשא',
            'Beha\'alotcha': 'בהעלותך',
            'Sh\'lach': 'שלח',
            'Korach': 'קרח',
            'Chukat': 'חקת',
            'Balak': 'בלק',
            'Pinchas': 'פינחס',
            'Matot': 'מטות',
            'Masei': 'מסעי',
            'Devarim': 'דברים',
            'Vaetchanan': 'ואתחנן',
            'Eikev': 'עקב',
            'Re\'eh': 'ראה',
            'Shoftim': 'שופטים',
            'Ki Teitzei': 'כי תצא',
            'Ki Tavo': 'כי תבוא',
            'Nitzavim': 'ניצבים',
            'Vayeilech': 'וילך',
            'Ha\'Azinu': 'האזינו',
            'Vezot Haberakhah': 'וזאת הברכה',
            // פרשות כפולות
            'Vayakhel-Pekudei': 'ויקהל-פקודי',
            'Tazria-Metzora': 'תזריע-מצורע',
            'Achrei Mot-Kedoshim': 'אחרי מות-קדושים',
            'Behar-Bechukotai': 'בהר-בחוקותי',
            'Chukat-Balak': 'חקת-בלק',
            'Matot-Masei': 'מטות-מסעי',
            'Nitzavim-Vayeilech': 'ניצבים-וילך'
        };
        
        // פונקציה לקביעת הפרשה הנוכחית לפי התאריך
        async function getCurrentParasha() {
            try {
                const today = new Date();
                const parashaDate = getParashaWeek(today);
                
                const parashaUrl = `https://www.hebcal.com/leyning?cfg=json&date=${parashaDate}`;
                const response = await fetch(parashaUrl);
                const data = await response.json();
                
                if (data?.items?.[0]?.name) {
                    // אם יש פרשה, החזר את השם העברי
                    if (data.items[0].name.he) {
                        // הסר ניקוד מהפרשה
                        return removeHebrewNiqqud(data.items[0].name.he);
                    }
                    
                    // אם אין שם עברי, נסה להמיר מאנגלית
                    const englishName = data.items[0].name;
                    if (parashaTranslation[englishName]) {
                        return parashaTranslation[englishName];
                    }
                    
                    // אם לא הצלחנו להמיר, החזר את השם באנגלית
                    return englishName;
                }
                
                // אם אין פרשה (יום חג למשל), נסה את השבת הבאה
                const nextWeek = new Date(today);
                nextWeek.setDate(today.getDate() + 7);
                const nextParashaDate = getParashaWeek(nextWeek);
                
                const nextParashaUrl = `https://www.hebcal.com/leyning?cfg=json&date=${nextParashaDate}`;
                const nextResponse = await fetch(nextParashaUrl);
                const nextData = await nextResponse.json();
                
                if (nextData?.items?.[0]?.name) {
                    if (nextData.items[0].name.he) {
                        return removeHebrewNiqqud(nextData.items[0].name.he);
                    }
                    
                    const nextEnglishName = nextData.items[0].name;
                    if (parashaTranslation[nextEnglishName]) {
                        return parashaTranslation[nextEnglishName];
                    }
                    
                    return nextEnglishName;
                }
                
                // אם עדיין לא הצלחנו, החזר ברירת מחדל
                return "בראשית";
            } catch (error) {
                console.error('שגיאה בחישוב פרשת השבוע:', error);
                return "בראשית"; // ברירת מחדל במקרה של שגיאה
            }
        }
        
        // פונקציה לטעינת בחירת הפרשות
        async function loadParashotOptions() {
            const selectElement = document.getElementById('parasha-select');
            
            // ניקוי אפשרויות קיימות פרט לאפשרות הראשונה
            while (selectElement.options.length > 1) {
                selectElement.remove(1);
            }
            
            try {
                // קבל את הפרשה הנוכחית
                const currentParasha = await getCurrentParasha();
                
                // רשימת פרשות קבועה (ללא ניקוד)
                const parashot = [
                    "בראשית", "נח", "לך לך", "וירא", "חיי שרה", "תולדות", "ויצא", "וישלח", "וישב", "מקץ",
                    "ויגש", "ויחי", "שמות", "וארא", "בא", "בשלח", "יתרו", "משפטים", "תרומה", "תצוה",
                    "כי תשא", "ויקהל", "פקודי", "ויקרא", "צו", "שמיני", "תזריע", "מצורע", "אחרי מות", "קדושים",
                    "אמור", "בהר", "בחוקותי", "במדבר", "נשא", "בהעלותך", "שלח", "קרח", "חקת", "בלק",
                    "פינחס", "מטות", "מסעי", "דברים", "ואתחנן", "עקב", "ראה", "שופטים", "כי תצא", "כי תבוא",
                    "ניצבים", "וילך", "האזינו", "וזאת הברכה",
                    // פרשות כפולות
                    "ויקהל-פקודי", "תזריע-מצורע", "אחרי מות-קדושים", "בהר-בחוקותי", 
                    "חקת-בלק", "מטות-מסעי", "ניצבים-וילך"
                ];
                
                // מילוי אפשרויות הבחירה
                parashot.forEach(parasha => {
                    const option = document.createElement('option');
                    option.value = parasha;
                    option.textContent = parasha;
                    
                    // סמן את הפרשה הנוכחית כנבחרת
                    if (parasha === currentParasha) {
                        option.selected = true;
                    }
                    
                    selectElement.appendChild(option);
                });
                
                // עדכון שם הפרשה בכותרת
                document.getElementById('current-parasha-name').textContent = currentParasha;
                document.querySelector('.page-title').textContent = `דבר תורה לפרשת ${currentParasha}`;
                
                return currentParasha;
            } catch (error) {
                console.error('שגיאה בטעינת הפרשות:', error);
                return "בראשית"; // ברירת מחדל
            }
        }
        
        // פונקציה לטעינת התוכן מגוגל שיטס
        async function loadParashaContent(parashaName = null) {
            try {
                // קבל את הפרשה הנוכחית אם לא נבחרה פרשה ספציפית
                if (!parashaName) {
                    parashaName = await getCurrentParasha();
                }
                
                // עדכון שם הפרשה בכותרת
                document.getElementById('current-parasha-name').textContent = parashaName;
                document.querySelector('.page-title').textContent = `דבר תורה לפרשת ${parashaName}`;
                
                // כאן נשתמש בקישור המוגדר בתחילת הקובץ
                const url = SHEET_URL;
                
                const response = await fetch(url);
                const csvText = await response.text();
                
                // נפרסר את ה-CSV
                const rows = parseCSV(csvText);
                
                // רשימת פרשות לחיפוש
                let searchParashas = [];
                
                // אם זו פרשה כפולה, חפש גם את הפרשות הבודדות
                if (parashaName.includes('-')) {
                    // הוסף את הפרשה הכפולה עצמה
                    searchParashas.push(parashaName);
                    
                    // הוסף וריאציות עם רווח במקום מקף
                    searchParashas.push(parashaName.replace('-', ' '));
                    
                    // הוסף את הפרשות הבודדות
                    const parts = parashaName.split('-');
                    searchParashas.push(parts[0].trim());
                    searchParashas.push(parts[1].trim());
                    
                    // טיפול בוואריאציות של בחוקותי/בחקתי
                    if (parts[1].trim() === "בחוקותי") {
                        searchParashas.push("בחקתי");
                    } else if (parts[1].trim() === "בחקתי") {
                        searchParashas.push("בחוקותי");
                    }
                    
                    // טיפול בווריאציות נוספות
                    if (parts[0].trim() === "ניצבים") {
                        searchParashas.push("נצבים");
                    }
                    if (parts[0].trim() === "חקת") {
                        searchParashas.push("חוקת");
                    }
                } else {
                    // אם זו פרשה רגילה, חפש רק אותה
                    searchParashas.push(parashaName);
                    
                    // הוסף וריאציות ידועות
                    if (parashaName === "בחוקותי") {
                        searchParashas.push("בחקתי");
                    } else if (parashaName === "בחקתי") {
                        searchParashas.push("בחוקותי");
                    } else if (parashaName === "ניצבים") {
                        searchParashas.push("נצבים");
                    } else if (parashaName === "חקת") {
                        searchParashas.push("חוקת");
                    }
                }
                
                console.log("מחפש פרשות:", searchParashas);
                
                // נסנן רק את הרשומות הזמינות עבור הפרשה הנוכחית או חלקיה
                const parashaEntries = [];
                
                // עבור על כל השורות בגיליון
                for (const row of rows) {
                    // ודא שיש מספיק עמודות בשורה
                    if (row.length <= 5) continue;
                    
                    const rowParasha = row[0].trim();
                    const isAvailable = (
                        row[5].trim().toLowerCase() === "כן" || 
                        row[5].trim().toLowerCase() === "yes" || 
                        row[5].trim() === "1"
                    );
                    
                    // אם השורה לא זמינה, דלג עליה
                    if (!isAvailable) continue;
                    
                    // בדוק אם הפרשה בשורה מתאימה לאחת מהפרשות שאנחנו מחפשים
                    for (const searchParasha of searchParashas) {
                        if (rowParasha === searchParasha) {
                            parashaEntries.push(row);
                            break; // מספיק התאמה אחת
                        }
                    }
                }
                
                console.log(`נמצאו ${parashaEntries.length} רשומות זמינות לפרשת ${parashaName}:`, parashaEntries);
                
                // אם יש רשומות לפרשה זו, הצג אותן
                if (parashaEntries.length > 0) {
                    // הצג את הראשון כתוכן ראשי
                    displayContent(parashaEntries[0]);
                    
                    // הצג בוחר תוכן אם יש יותר מרשומה אחת
                    if (parashaEntries.length > 1) {
                        displayContentSelector(parashaEntries, 0); // האינדקס הראשון פעיל כברירת מחדל
                    } else {
                        // אם יש רק רשומה אחת, וודא שבוחר התוכן מוסתר
                        const selectorContainer = document.getElementById('content-selector');
                        if (selectorContainer) {
                            selectorContainer.style.display = 'none';
                        }
                    }
                } else {
                    // אם אין רשומות, הצג הודעה מתאימה
                    document.getElementById('content-area').innerHTML = `
                        <div class="content-container">
                            <div class="content-header">
                                <h3 class="content-title">אין תוכן זמין</h3>
                            </div>
                            <div class="content-body">
                                <p>אין כרגע דבר תורה זמין לפרשת ${parashaName}.</p>
                            </div>
                        </div>
                    `;
                    
                    // הסתר בוחר התוכן
                    const selectorContainer = document.getElementById('content-selector');
                    if (selectorContainer) {
                        selectorContainer.style.display = 'none';
                    }
                }
                
                // טעינת ארכיון פרשות קודמות (מפרשות שונות) - רק פריטים זמינים
                const otherParashot = [];
                
                for (const row of rows) {
                    // ודא שיש מספיק עמודות בשורה
                    if (row.length <= 5) continue;
                    
                    const rowParasha = row[0].trim();
                    const isAvailable = (
                        row[5].trim().toLowerCase() === "כן" || 
                        row[5].trim().toLowerCase() === "yes" || 
                        row[5].trim() === "1"
                    );
                    
                    // אם השורה לא זמינה, דלג עליה
                    if (!isAvailable) continue;
                    
                    // בדוק שהפרשה אינה אחת מהפרשות שאנחנו כבר מציגים
                    let isInCurrentParashas = false;
                    for (const searchParasha of searchParashas) {
                        if (rowParasha === searchParasha) {
                            isInCurrentParashas = true;
                            break;
                        }
                    }
                    
                    // אם זו לא פרשה שאנחנו כבר מציגים, הוסף לארכיון
                    if (!isInCurrentParashas) {
                        otherParashot.push(row);
                    }
                }
                
                loadArchiveItems(otherParashot);
                
            } catch (error) {
                document.getElementById('content-area').innerHTML = `
                    <div class="content-container">
                        <div class="content-header">
                            <h3 class="content-title">שגיאה בטעינת התוכן</h3>
                        </div>
                        <div class="content-body">
                            <p>לא ניתן לטעון את התוכן כרגע. אנא נסה שוב מאוחר יותר.</p>
                            <p>פרטי השגיאה: ${error.message}</p>
                        </div>
                    </div>
                `;
                console.error('Error loading content:', error);
            }
        }
        
        // פונקציה להצגת בוחר התוכן כשיש מספר דברי תורה לאותה פרשה
        function displayContentSelector(entries, activeIndex) {
            const selectorContainer = document.getElementById('content-selector');
            selectorContainer.innerHTML = '';
            selectorContainer.style.display = 'flex';
            
            entries.forEach((entry, index) => {
                // בהנחה שהעמודות בסדר: פרשה, תאריך עדכון, כותרת, תוכן, כותב, זמין, שנה
                const [parasha, updateDate, title, content, author, isAvailable, year] = entry;
                
                const card = document.createElement('div');
                card.className = `content-card ${index === activeIndex ? 'active' : ''}`;
                card.innerHTML = `
                    <h4>${title}</h4>
                    <p>מאת: ${author}</p>
                    ${year ? `<span class="year-tag">${year}</span>` : ''}
                `;
                
                card.addEventListener('click', function() {
                    // הסר את המחלקה 'active' מכל הכרטיסיות
                    document.querySelectorAll('.content-card').forEach(c => c.classList.remove('active'));
                    // הוסף את המחלקה 'active' לכרטיסיה הנוכחית
                    this.classList.add('active');
                    // הצג את התוכן המתאים
                    displayContent(entries[index]);
                });
                
                selectorContainer.appendChild(card);
            });
        }
        
        // פונקציה פשוטה לפרסור CSV
        function parseCSV(text) {
            const rows = [];
            const lines = text.split('\n');
            
            console.log("מספר שורות בקובץ CSV:", lines.length);
            
            // נדלג על שורת הכותרות
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                
                // פירוק שורה תוך התחשבות במרכאות
                let row = [];
                let inQuotes = false;
                let currentValue = '';
                
                for (let j = 0; j < lines[i].length; j++) {
                    const char = lines[i][j];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        row.push(currentValue);
                        currentValue = '';
                    } else {
                        currentValue += char;
                    }
                }
                
                row.push(currentValue); // הוספת הערך האחרון
                rows.push(row);
            }
            
            console.log("שורות לאחר פרסור:", rows);
            return rows;
        }
        
        // הצגת התוכן הראשי בעמוד
        function displayContent(contentRow) {
            // בהנחה שהעמודות בסדר: פרשה, תאריך עדכון, כותרת, תוכן, כותב, זמין, שנה
            const [parasha, updateDate, title, content, author, isAvailable, year] = contentRow;
            
            const contentHtml = `
                <div class="content-container">
                    <div class="content-header">
                        <h3 class="content-title">
                            ${year ? `<span class="year-badge">${year}</span>` : ''}
                            ${title}
                        </h3>
                        <div class="content-meta">
                            <span>מאת: ${author}</span> | 
                            <span>עודכן בתאריך: ${updateDate}</span>
                        </div>
                    </div>
                    <div class="content-body">
                        ${content}
                    </div>
                </div>
            `;
            
            document.getElementById('content-area').innerHTML = contentHtml;
        }
        
        // טעינת ארכיון פרשות קודמות
        function loadArchiveItems(rows) {
            const archiveContainer = document.getElementById('archive-items');
            archiveContainer.innerHTML = '';
            
            // מיון השורות לפי תאריך (מהחדש לישן)
            rows.sort((a, b) => {
                if (a.length < 2 || b.length < 2) return 0;
                const dateA = new Date(a[1]);
                const dateB = new Date(b[1]);
                return dateB - dateA;
            });
            
            // מספר מוגבל של פריטים להצגה בארכיון
            const maxItems = 4;
            let count = 0;
            
            for (const row of rows) {
                // ודא שיש מספיק עמודות בשורה
                if (row.length < 5) continue;
                
                // בהנחה שהעמודות בסדר: פרשה, תאריך עדכון, כותרת, תוכן, כותב, זמין, שנה
                const [parasha, updateDate, title, content, author, isAvailable, year] = row;
                
                // דלג על שורות לא תקינות
                if (!parasha || !title) continue;
                
                // הגבלת מספר הפריטים
                if (count >= maxItems) break;
                
                const archiveItem = document.createElement('div');
                archiveItem.className = 'archive-item';
                archiveItem.innerHTML = `
                    <h4>${title}</h4>
                    <p>פרשת ${parasha} ${year ? `(${year})` : ''}</p>
                    <p>מאת: ${author}</p>
                    <a href="#" onclick="loadParashaContent('${parasha}'); return false;">לקריאה</a>
                `;
                
                archiveContainer.appendChild(archiveItem);
                count++;
            }
            
            if (count === 0) {
                archiveContainer.innerHTML = '<p style="text-align: center; grid-column: 1/-1;">אין דברי תורה קודמים בארכיון.</p>';
            }
        }
        
        // אתחול הדף כשהוא נטען
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                // הצג תאריך עברי
                await displayHebrewDate();
                
                // טען את רשימת הפרשות עם הפרשה הנוכחית מסומנת
                const currentParasha = await loadParashotOptions();
                
                // טען את התוכן של הפרשה הנוכחית
                await loadParashaContent(currentParasha);
            } catch (error) {
                console.error('שגיאה באתחול הדף:', error);
                // טען גרסה פשוטה במקרה של שגיאה
                document.querySelector('.page-title').textContent = 'דבר תורה לפרשת השבוע';
                document.getElementById('current-parasha-name').textContent = 'בראשית';
                loadParashaContent('בראשית');
            }
        });
    </script>
</body>
</html>
